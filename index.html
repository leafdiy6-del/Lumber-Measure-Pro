<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©¡æœ¨å¤§å¸ˆ V16.0</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --accent-color: #d4a373; /* ç¥ç€æœ¨è‰² */
            --active-text: #000;
            --input-bg: #2a2a2a;
            --border-color: #333;
            --danger-color: #ff5252;
        }

        /* --- æ‰“å°/PDF æ¨¡å¼ --- */
        body.print-mode { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
        body.print-mode .header, body.print-mode .global-section, body.print-mode .log-card, 
        body.print-mode .footer, body.print-mode .btn-del-mini, body.print-mode .btn-add-inline, 
        body.print-mode .btn-exit-print { display: none !important; }
        
        /* æ‰“å°ä¸“ç”¨å¤´éƒ¨è¡¨æ ¼ */
        .print-header-table { display: none; width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        body.print-mode .print-header-table { display: table !important; }
        .print-header-table td { border: 1px solid #000; padding: 5px; color: #000; }

        /* æ‰“å°åˆ—è¡¨ */
        body.print-mode .list-header { 
            background: #eee !important; color: black !important; border: 1px solid #000; position: static !important;
            grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 1.2fr 2fr !important;
        }
        body.print-mode .log-row { 
            background: transparent !important; color: black !important; border: 1px solid #000; border-top: none;
            grid-template-columns: 2fr 0.8fr 0.8fr 0.8fr 1.2fr 2fr !important; 
        }
        body.print-mode input, body.print-mode select { 
            color: black !important; background: transparent !important; border: none !important; 
            text-align: center; width: 100%; font-weight: normal; appearance: none;
        }
        body.print-mode .col-vol { color: black !important; }
        .print-summary-box { display: none; margin-top: 20px; border: 2px solid #000; padding: 10px; }
        body.print-mode .print-summary-box { display: block !important; }
        .btn-exit-print { display: none; width: 100%; background: #333; color: #fff; padding: 15px; margin-bottom: 20px; border: none; border-radius: 8px; font-size: 16px; }
        body.print-mode .btn-exit-print { display: block !important; }

        /* å¼ºåŠ›å»é¡µçœ‰é¡µè„š */
        @media print {
            @page { margin: 0; size: auto; }
            body.print-mode { padding: 1.5cm !important; }
            .btn-exit-print { display: none !important; }
        }

        /* --- æ­£å¸¸æ¨¡å¼ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; padding-bottom: 110px; background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, sans-serif; font-size: 14px; }

        .header { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .btn-header { padding: 6px 10px; border-radius: 4px; border: none; font-weight: bold; font-size: 11px; }
        .btn-info { background: #444; color: #fff; display: flex; align-items: center; gap: 4px; border: 1px solid #555; }
        .btn-export { background: var(--accent-color); color: #000; margin-left: 5px; }
        .btn-pdf { background: #555; color: #fff; margin-left: 5px; }
        .btn-reset { background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); }

        /* å…¨å±€ä¿¡æ¯åŒº - æç®€æ¨¡å¼ */
        .global-section { margin-top: 60px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-box { display: flex; flex-direction: column; }
        .input-box label { font-size: 11px; color: #888; margin-bottom: 2px; }
        input, select { background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; height: 38px; border-radius: 4px; padding: 0 8px; font-size: 14px; width: 100%; }

        .list-header { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; padding: 10px; background: #252525; margin-top: 10px; font-size: 11px; color: #888; position: sticky; top: 50px; z-index: 90; }

        .log-card { background: var(--card-bg); margin: 10px; border-radius: 8px; padding: 15px; border: 2px solid var(--accent-color); box-shadow: 0 4px 15px rgba(212,163,115,0.2); }
        .card-title { font-size: 10px; color: var(--accent-color); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; }
        .card-row-1 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .card-row-2 { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 10px; margin-bottom: 15px; align-items: end; }
        .field { display: flex; flex-direction: column; gap: 4px; }
        .field label { font-size: 11px; color: #888; }
        .field input { height: 44px; font-size: 18px; border-color: var(--accent-color); font-weight: bold; }
        .input-note { font-size: 14px !important; font-weight: normal !important; color: #bbb !important; }
        .live-vol-display { height: 44px; background: rgba(0,0,0,0.3); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--accent-color); font-size: 20px; font-weight: bold; font-family: monospace; border: 1px solid #333; }
        
        .grade-label { font-size: 11px; color: #888; margin-bottom: 5px; }
        .grade-container { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 15px; }
        .btn-grade { flex: 1; height: 40px; background: #333; border: 1px solid #444; color: #888; border-radius: 6px; font-weight: bold; font-size: 14px; padding: 0; }
        .btn-grade.active { background: var(--accent-color); color: var(--active-text); border-color: var(--accent-color); box-shadow: 0 0 8px rgba(212,163,115,0.4); }
        .btn-add-inline { width: 100%; height: 50px; background: var(--accent-color); color: #000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .btn-add-inline:active { transform: scale(0.98); }

        .log-row { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; gap: 4px; padding: 6px 10px; background: var(--card-bg); border-bottom: 1px solid #2a2a2a; align-items: center; }
        .log-row input { height: 34px; font-size: 13px; border: none; background: transparent; text-align: center; }
        .log-row select { height: 34px; font-size: 13px; border: none; background: transparent; text-align: center; color: #fff; font-weight: bold; appearance: none; -webkit-appearance: none; }
        .log-row input:first-child, .log-row input:nth-child(6) { text-align: left; }
        .col-vol { color: var(--accent-color); font-weight: bold; font-family: monospace; text-align: center; font-size: 12px; }
        .btn-del-mini { color: var(--danger-color); background: none; border: none; font-size: 18px; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .stats-detail { display: flex; overflow-x: auto; padding: 8px; gap: 8px; font-size: 11px; border-bottom: 1px solid #222; }
        .stat-tag { background: #2a2a2a; padding: 2px 8px; border-radius: 10px; white-space: nowrap; }
        .stats-main { display: flex; justify-content: space-around; padding: 15px 10px; font-weight: bold; align-items: baseline; }
        /* 1. å­—ä½“åŠ å¤§ */
        .stats-main span { font-size: 14px; color: #aaa; }
        .stats-main span strong { font-size: 24px; color: var(--accent-color); margin-left: 5px; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px; flex-direction: column; justify-content: center; }
        .modal-card { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .modal-title { font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .info-row { margin-bottom: 15px; }
        .info-row label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        .info-controls { display: flex; gap: 5px; }
        .btn-tool { background: #333; border: 1px solid #444; color: #ccc; width: 40px; height: 38px; border-radius: 4px; border: none; flex-shrink: 0; }

        .export-text { flex: 1; background: #111; color: #fff; border: 1px solid #444; padding: 10px; font-size: 12px; margin-bottom: 10px; }
        .btn-block { width: 100%; height: 45px; border-radius: 6px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <button class="btn-exit-print" onclick="togglePrintMode()">â¬… è¿”å›ç¼–è¾‘æ¨¡å¼</button>

    <table class="print-header-table">
        <tr><td width="15%">æ—¥æœŸ:</td><td width="35%" id="p_date"></td><td width="15%">é›†è£…ç®±:</td><td width="35%" id="p_container"></td></tr>
        <tr><td>å–æ–¹:</td><td id="p_seller"></td><td>åœ°ç‚¹:</td><td id="p_location"></td></tr>
        <tr><td>æµ‹é‡äºº:</td><td id="p_measurer" colspan="3"></td></tr>
        <tr><td>å¤‡æ³¨:</td><td id="p_note" colspan="3"></td></tr>
    </table>

    <header class="header">
        <div style="display: flex; gap: 10px;">
            <button class="btn-header btn-reset" onclick="resetLogOnly()">âŸ³ æ–°æŸœ</button>
            <button class="btn-header btn-info" onclick="openInfoModal()">ğŸ“‹ é¡¹ç›®ä¿¡æ¯</button>
        </div>
        <div style="display: flex;">
            <button class="btn-header btn-pdf" onclick="togglePrintMode()">PDF</button>
            <button class="btn-header btn-export" onclick="exportData()">EXCEL</button>
        </div>
    </header>

    <div class="global-section">
        <div class="input-box"><label>é›†è£…ç®±å·</label><input type="text" id="g_container" oninput="updateGlobal()"></div>
        <div class="input-box"><label>æ•´å•å¤‡æ³¨ (Global Note)</label><input type="text" id="g_note" oninput="updateGlobal()"></div>
    </div>

    <div id="logList"></div>
    <div class="print-summary-box" id="printSummary"></div>

    <div class="footer">
        <div class="stats-detail" id="statsDetail"></div>
        <div class="stats-main">
            <span>æ€»æ•°:<strong id="totalCount">0</strong></span>
            <span>æç§¯:<strong id="totalVol">0.000</strong> mÂ³</span>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">ğŸ“‹ å¡«å†™é¡¹ç›®ä¿¡æ¯</div>
            
            <div class="info-row">
                <label>å–æ–¹å…¬å¸ (Seller)</label>
                <div class="info-controls"><input type="text" id="g_seller" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('seller')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('seller')">ğŸ“–</button></div>
            </div>
            <div class="info-row">
                <label>æµ‹é‡äºº (Measurer)</label>
                <div class="info-controls"><input type="text" id="g_measurer" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('measurer')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('measurer')">ğŸ“–</button></div>
            </div>
            <div class="info-row">
                <label>åœ°ç‚¹ (Location)</label>
                <div class="info-controls"><input type="text" id="g_location" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('location')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('location')">ğŸ“–</button></div>
            </div>

            <button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="closeInfoModal()">å®Œæˆ / å…³é—­</button>
        </div>
    </div>

    <div id="historyPop" class="modal-overlay" onclick="this.style.display='none'">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-title">é€‰æ‹©å†å²è®°å½•</div>
            <div id="historyList" style="max-height:300px; overflow-y:auto;"></div>
            <button class="btn-block" style="background:#333; color:#fff;" onclick="document.getElementById('historyPop').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <div id="exportModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">Excel æ•°æ®å†…å®¹</div>
            <textarea id="exportText" class="export-text" rows="10"></textarea>
            <button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="copyExportText()">å¤åˆ¶å…¨éƒ¨</button>
            <button class="btn-block" style="background:#444; color:#fff;" onclick="document.getElementById('exportModal').style.display='none'">å…³é—­</button>
        </div>
    </div>

    <script>
        let logs = [];
        let globalInfo = { container: '', note: '', seller: '', measurer: '', location: '' };
        let histories = { seller: [], measurer: [], location: [] };
        const STORAGE_KEY = 'oak_v16_data';
        const HIST_KEY = 'oak_v16_hist';
        const GRADES = ['A+', 'A', 'B', 'C', 'D', 'E'];

        window.onload = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if(savedData) {
                const p = JSON.parse(savedData);
                logs = p.logs || [];
                globalInfo = p.global || globalInfo;
                // æ¢å¤æ•°æ®åˆ°è¾“å…¥æ¡†
                ['container', 'note', 'seller', 'measurer', 'location'].forEach(k => {
                    const el = document.getElementById('g_'+k);
                    if(el) el.value = globalInfo[k] || '';
                });
            }
            const savedHist = localStorage.getItem(HIST_KEY);
            if(savedHist) histories = JSON.parse(savedHist);
            if(logs.length === 0) addNewLog();
            renderAll();
        };

        function updateGlobal() { 
            ['container', 'note', 'seller', 'measurer', 'location'].forEach(k => {
                globalInfo[k] = document.getElementById('g_'+k).value;
            });
            save(); 
        }
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ logs, global: globalInfo })); updateStats(); }
        
        // 2. è‡ªåŠ¨é€—å·è½¬ç‚¹ï¼šè¾“å…¥ 3,5 -> 3.5
        function cleanInput(val) { 
            if(!val) return '';
            return val.replace(/,/g, '.').replace(/[^0-9.]/g, ''); 
        }
        // å½“è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œæˆ–è€…è®¡ç®—æ—¶ï¼Œè‡ªåŠ¨ä¿®æ­£æ˜¾ç¤ºçš„å€¼
        function autoFixInput(input) {
            let val = input.value;
            if(val.includes(',')) {
                input.value = val.replace(/,/g, '.');
                // è§¦å‘ä¸€æ¬¡ update
                const id = input.getAttribute('data-id');
                const field = input.getAttribute('data-field');
                if(id && field) updateItem(parseInt(id), field, input.value);
            }
        }

        function getNextCode() {
            if(logs.length === 0) return '';
            const match = logs[0].code.match(/^(.*?)(\d+)$/);
            return match ? match[1] + (parseInt(match[2]) + 1).toString().padStart(match[2].length, '0') : logs[0].code; 
        }

        function addNewLog() {
            // æ·»åŠ å‰å…ˆæŠŠæ‰€æœ‰é€—å·ä¿®ä¸€ä¸‹
            document.querySelectorAll('input').forEach(i => autoFixInput(i));

            const newLog = { id: Date.now(), code: getNextCode(), grade: 'A', length: '', diameter: '', volume: 0, note: '' };
            logs.unshift(newLog);
            save();
            renderAll();
            setTimeout(() => {
                const firstCard = document.querySelector('.log-card');
                if(firstCard) firstCard.querySelector('.in-l').focus();
            }, 50);
        }

        function renderAll() {
            const container = document.getElementById('logList');
            container.innerHTML = '';
            if(logs.length > 1) {
                const header = document.createElement('div');
                header.className = 'list-header';
                header.innerHTML = '<div>ç å·</div><div>ç­‰çº§</div><div>L(m)</div><div>D(cm)</div><div>ä½“ç§¯</div><div>å¤‡æ³¨</div><div></div>';
                container.appendChild(header);
            }
            logs.forEach((log, index) => {
                if(index === 0) container.insertBefore(createCard(log), container.firstChild);
                else container.appendChild(createRow(log));
            });
            updateStats();
        }

        function createCard(log) {
            let btnsHtml = '';
            GRADES.forEach(g => {
                const isActive = log.grade === g ? 'active' : '';
                btnsHtml += `<button class="btn-grade ${isActive}" onclick="setGrade(${log.id}, '${g}')">${g}</button>`;
            });

            const div = document.createElement('div');
            div.className = 'log-card';
            div.innerHTML = `
                <div class="card-title">â— æ­£åœ¨è¾“å…¥ (NO. ${logs.length})</div>
                <div class="card-row-1">
                    <div class="field"><label>ç å·</label><input type="text" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)"></div>
                    <div class="field"><label>å¤‡æ³¨ (Note)</label><input type="text" class="input-note" value="${log.note || ''}" placeholder="" oninput="updateItem(${log.id},'note',this.value)"></div>
                </div>
                <div class="card-row-2">
                    <div class="field">
                        <label>é•¿åº¦ (m)</label>
                        <input type="text" inputmode="decimal" class="in-l" value="${log.length}" 
                               data-id="${log.id}" data-field="length"
                               oninput="updateItem(${log.id},'length',this.value)"
                               onblur="autoFixInput(this)">
                    </div>
                    <div class="field">
                        <label>ç›´å¾„ (cm)</label>
                        <input type="text" inputmode="decimal" value="${log.diameter}" 
                               data-id="${log.id}" data-field="diameter"
                               oninput="updateItem(${log.id},'diameter',this.value)"
                               onblur="autoFixInput(this)">
                    </div>
                    <div class="live-vol-display" id="v-${log.id}">${log.volume.toFixed(3)} mÂ³</div>
                </div>
                <div class="grade-label">é€‰æ‹©ç­‰çº§ (Grade)</div>
                <div class="grade-container">${btnsHtml}</div>
                <button class="btn-add-inline" onclick="addNewLog()">+ æ·»åŠ å¹¶ä¸‹ä¸€æ ¹ (Next)</button>
            `;
            return div;
        }

        function createRow(log) {
            let gradeOptions = GRADES.map(g => `<option value="${g}" ${log.grade===g?'selected':''}>${g}</option>`).join('');

            const div = document.createElement('div');
            div.className = 'log-row';
            div.id = 'row-' + log.id;
            div.innerHTML = `
                <input type="text" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)">
                <select onchange="updateItem(${log.id},'grade',this.value)">${gradeOptions}</select>
                <input type="text" inputmode="decimal" value="${log.length}" oninput="updateItem(${log.id},'length',this.value)" onblur="autoFixInput(this)">
                <input type="text" inputmode="decimal" value="${log.diameter}" oninput="updateItem(${log.id},'diameter',this.value)" onblur="autoFixInput(this)">
                <div class="col-vol" id="v-row-${log.id}">${log.volume.toFixed(3)}</div>
                <input type="text" style="font-size:12px;color:#aaa;text-align:left;" value="${log.note||''}" placeholder="..." oninput="updateItem(${log.id},'note',this.value)">
                <button class="btn-del-mini" onclick="delItem(${log.id})">Ã—</button>
            `;
            return div;
        }

        function setGrade(id, grade) { updateItem(id, 'grade', grade); renderAll(); }

        function updateItem(id, field, val) {
            const item = logs.find(l => l.id === id);
            item[field] = val;
            
            if(field === 'length' || field === 'diameter') {
                // æ ¸å¿ƒä¿®å¤ï¼šæŠŠé€—å·è½¬æˆç‚¹ï¼Œç¡®ä¿è®¡ç®—æ­£ç¡®
                let l_str = item.length.toString().replace(/,/g, '.');
                let d_str = item.diameter.toString().replace(/,/g, '.');
                
                const l = parseFloat(l_str);
                const d = parseFloat(d_str);
                
                if (!isNaN(l) && !isNaN(d) && l > 0 && d > 0) {
                    // 2. é•¿åº¦å•ä½å›å½’ï¼šç›´æ¥ç”¨ç±³è®¡ç®—
                    // V = pi * (D/200)^2 * L(m)
                    const radius_m = d / 200;
                    item.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * l).toFixed(3));
                } else {
                    item.volume = 0;
                }
                const vDisplay = document.getElementById('v-'+id); if(vDisplay) vDisplay.innerText = item.volume.toFixed(3) + ' mÂ³';
                const vRowDisplay = document.getElementById('v-row-'+id); if(vRowDisplay) vRowDisplay.innerText = item.volume.toFixed(3);
            }
            save();
        }

        function delItem(id) { if(confirm('åˆ é™¤è®°å½•?')) { logs = logs.filter(l => l.id !== id); renderAll(); save(); } }
        function resetLogOnly() { if(confirm('å¼€å§‹æ–°æŸœè®°å½•ï¼Ÿ\n(å¤´éƒ¨ä¿¡æ¯ä¿ç•™)')) { logs = []; save(); location.reload(); } }

        function updateStats() {
            const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
            const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
            document.getElementById('totalCount').innerText = validLogs.length;
            document.getElementById('totalVol').innerText = totalV.toFixed(3);
            
            const gStats = {}; let l4 = 0, l25 = 0;
            validLogs.forEach(l => {
                gStats[l.grade] = (gStats[l.grade] || 0) + 1;
                // é•¿åº¦ç›´æ¥ç”¨ç±³åˆ¤æ–­
                const len_m = parseFloat(l.length.replace(/,/g, '.'));
                if(len_m < 4.0) l4++;
                if(len_m < 2.5) l25++;
            });

            let html = '';
            for(let g in gStats) html += `<div class="stat-tag">${g}: <b style="color:var(--accent-color)">${gStats[g]}</b></div>`;
            html += `<div class="stat-tag"> < 4m: <b>${l4}</b></div>`;
            html += `<div class="stat-tag"> < 2.5m: <b>${l25}</b></div>`;
            document.getElementById('statsDetail').innerHTML = html;

            let summaryHtml = `<h3>ç»Ÿè®¡æ±‡æ€»</h3><p>æ€»æ ¹æ•°: ${validLogs.length} &nbsp;&nbsp;&nbsp; æ€»æç§¯: ${totalV.toFixed(3)} mÂ³</p><p>ç­‰çº§: `;
            for(let g in gStats) summaryHtml += `${g}: ${gStats[g]};  `;
            summaryHtml += `</p>`;
            document.getElementById('printSummary').innerHTML = summaryHtml;
        }

        // --- å¼¹çª—é€»è¾‘ ---
        function openInfoModal() { document.getElementById('infoModal').style.display = 'flex'; }
        function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; updateGlobal(); }

        function togglePrintMode() {
            const body = document.body;
            if (body.classList.contains('print-mode')) {
                body.classList.remove('print-mode');
            } else {
                const d=new Date();
                document.getElementById('p_date').innerText = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
                document.getElementById('p_container').innerText = globalInfo.container;
                document.getElementById('p_note').innerText = globalInfo.note;
                document.getElementById('p_seller').innerText = globalInfo.seller;
                document.getElementById('p_measurer').innerText = globalInfo.measurer;
                document.getElementById('p_location').innerText = globalInfo.location;
                body.classList.add('print-mode');
                setTimeout(() => { try { window.print(); } catch(e){} }, 300);
            }
        }

        async function exportData() {
            const d = new Date(); const ds = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
            let csv = `\ufeffæ—¥æœŸ,${ds}\né›†è£…ç®±å·,${globalInfo.container}\næ•´å•å¤‡æ³¨,${globalInfo.note}\nå–æ–¹å…¬å¸,${globalInfo.seller}\næµ‹é‡äºº,${globalInfo.measurer}\nåœ°ç‚¹,${globalInfo.location}\n\nç å·,ç­‰çº§,é•¿åº¦(m),ç›´å¾„(cm),ä½“ç§¯(m3),å¤‡æ³¨\n`;
            
            const validLogs = logs.filter(l => parseFloat(l.volume) > 0);

            [...validLogs].reverse().forEach(l => { 
                // ç¡®ä¿é•¿åº¦æ˜¯ç‚¹æ ¼å¼ï¼Œé¿å…csvé”™ä¹±
                let len = l.length.replace(/,/g, '.');
                let dia = l.diameter.replace(/,/g, '.');
                csv += `${l.code},${l.grade},${len},${dia},${l.volume.toFixed(3)},${l.note||''}\n`; 
            });
            
            const totalV = validLogs.reduce((s, l) => s + l.volume, 0);

            let l4 = 0, l25 = 0;
            validLogs.forEach(l => {
                const len_m = parseFloat(l.length.replace(/,/g, '.'));
                if(len_m < 4.0) l4++;
                if(len_m < 2.5) l25++;
            });

            csv += `\n=== ç»Ÿè®¡ ===\næ€»æ ¹æ•°,${validLogs.length}\næ€»æç§¯,${totalV.toFixed(3)}\n`;
            csv += `4ç±³ä»¥ä¸‹æ•°é‡,${l4}\n`;
            csv += `2.5ç±³ä»¥ä¸‹æ•°é‡,${l25}\n`;
            csv += `\n=== ç­‰çº§ ===\n`;
            const gStats = {}; validLogs.forEach(l => { gStats[l.grade] = (gStats[l.grade] || 0) + 1; });
            for(let g in gStats) csv += `${g},${gStats[g]}\n`;

            if (navigator.share) {
                try {
                    await navigator.share({ files: [new File([csv], `æ©¡æœ¨_${globalInfo.container||'Data'}.csv`, {type: 'text/csv'})], title: 'Export' });
                    return;
                } catch (e) {}
            }
            document.getElementById('exportText').value = csv;
            document.getElementById('exportModal').style.display = 'flex';
        }
        function copyExportText() { document.getElementById('exportText').select(); document.execCommand('copy'); alert('å·²å¤åˆ¶'); document.getElementById('exportModal').style.display='none'; }
        
        function saveToHistory(t){const v=document.getElementById('g_'+t).value.trim();if(v&&!histories[t].includes(v)){histories[t].push(v);localStorage.setItem(HIST_KEY,JSON.stringify(histories));alert('å·²ä¿å­˜');}}
        function showHistory(t){
            const l=document.getElementById('historyList');l.innerHTML='';
            const items = histories[t] || [];
            if(items.length===0) l.innerHTML='<div style="padding:10px;color:#666;">æš‚æ— è®°å½•</div>';
            items.forEach((i,x)=>{
                const d=document.createElement('div');
                d.style.cssText='padding:12px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;';
                d.innerHTML=`<div onclick="selectHistory('${t}','${i}')" style="flex:1;color:#fff;">${i}</div><div onclick="delHistory('${t}',${x})" style="color:red;padding:5px 10px;font-size:18px;">Ã—</div>`;
                l.appendChild(d);
            });
            document.getElementById('historyPop').style.display='flex';
        }
        function selectHistory(t,v){document.getElementById('g_'+t).value=v;globalInfo[t]=v;document.getElementById('historyPop').style.display='none';save();}
        function delHistory(t,i){histories[t].splice(i,1);localStorage.setItem(HIST_KEY,JSON.stringify(histories));showHistory(t);}
    </script>
       <script>
if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
  </body>
</html>
