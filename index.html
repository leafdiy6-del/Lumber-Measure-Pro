<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
    <link rel="apple-touch-icon" href="icon.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Oak Master Gold V28.6</title>
<style>
    :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e0e0e0;
        --accent-color: #d4a373; /* æ©¡æœ¨é‡‘ */
        --gold-highlight: #ffd700;
        --input-bg: #2a2a2a;
        --border-color: #333;
        --danger-color: #ff5252;
        --active-mode: #4caf50;
    }

    /* --- ç¼–è¾‘æ¨¡å¼æ ·å¼ --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; padding-bottom: 120px; background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 14px; transition: background-color 0.3s; }

    .header { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; 
              padding: 0 10px; z-index: 100; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .btn-header { padding: 6px 12px; border-radius: 6px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; transition: opacity 0.2s; }
    .btn-info { background: #333; color: #fff; display: flex; align-items: center; gap: 5px; border: 1px solid #444; }
    .btn-export { background: var(--accent-color); color: #000; margin-left: 5px; }
    .btn-pdf { background: #555; color: #fff; margin-left: 5px; }
    .btn-reset { background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); }

    #logList { margin-top: 60px; }

    input, select { background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; height: 38px; border-radius: 4px; padding: 0 8px; font-size: 14px; width: 100%; }
    input:focus, select:focus { border-color: var(--accent-color); outline: none; }

    .list-header { display: grid; grid-template-columns: 0.5fr 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; padding: 10px; background: #252525; 
                   font-size: 11px; color: #888; position: sticky; top: 50px; z-index: 90; border-bottom: 1px solid #333; }
/* ç´§è·Ÿåœ¨ä¸‹é¢,æ·»åŠ è¿™ 5 è¡Œå¾®è°ƒ,ç¡®ä¿æ ‡é¢˜å³ç§» */ .list-header div:nth-child(2) { padding-left: 25px; } /* ç å·æ ‡é¢˜ */ .list-header div:nth-child(3) {
    margin-left: -15px; /* ç”¨è´Ÿæ•°å¼ºè¡Œå¾€å·¦æ‹½,æ•°å€¼è¶Šå¤§æ‹‰å¾—è¶ŠçŒ› */
    padding-left: 0;
}{ padding-left: 10px; } /* ç­‰çº§æ ‡é¢˜ */ .list-header div:nth-child(4) { padding-left: 3px; } /* é•¿åº¦æ ‡é¢˜ */ .list-header div:nth-child(5) { padding-left: 3px; } /* ç›´å¾„æ ‡é¢˜ */ .list-header div:nth-child(6) { padding-left: 25px; } /* ä½“ç§¯æ ‡é¢˜ */.list-header div:nth-child(7) { padding-left: 25px; } /* å¤‡æ³¨æ ‡é¢˜ */

    .log-card { background: var(--card-bg); margin: 10px; border-radius: 8px; padding: 15px; border: 2px solid var(--accent-color); box-shadow: 0 4px 15px rgba(212,163,115,0.15); }
    .card-title { font-size: 10px; color: var(--accent-color); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .card-row-1 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .card-row-2 { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 10px; margin-bottom: 15px; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 11px; color: #888; }
    .field input { height: 44px; font-size: 18px; border-color: #555; font-weight: bold; transition: border-color 0.2s; }
    .field input:focus { border-color: var(--accent-color); background: #333; }
    .input-note { font-size: 14px !important; font-weight: normal !important; color: #bbb !important; }
    .live-vol-display { height: 44px; background: rgba(0,0,0,0.3); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--accent-color); font-size: 20px; font-weight: bold; font-family: monospace; border: 1px solid #333; }
    
    .double-input-container { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .double-input-container input { text-align: center; font-size: 18px; font-weight: bold; }

    .grade-section { display: block; }
    .grade-section.hidden { display: none; }
    .grade-label { font-size: 11px; color: #888; margin-bottom: 5px; }
    
    .grade-container { 
        display: grid; 
        grid-template-columns: repeat(6, 1fr); 
        gap: 5px; 
        margin-bottom: 15px; 
        width: 100%;
    }
    .btn-grade { 
        width: 100%; 
        height: 42px; 
        background: #333; 
        border: 1px solid #444; 
        color: #888; 
        border-radius: 6px; 
        font-weight: bold; 
        font-size: 15px; 
        padding: 0; 
        cursor: pointer; 
        transition: all 0.1s; 
    }
    .btn-grade:active { transform: scale(0.95); }
    .btn-grade.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 10px rgba(212,163,115,0.4); }

    .btn-add-inline { width: 100%; height: 50px; background: var(--accent-color); color: #000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-top: 5px; }
    .btn-add-inline:active { transform: scale(0.98); background: #c59363; }

    .log-row { display: grid; grid-template-columns: 0.5fr 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; gap: 4px; padding: 8px 10px; background: var(--card-bg); border-bottom: 1px solid #2a2a2a; align-items: center; }
.log-row input:nth-child(2) { padding-left: 10px; text-align: left; } /* ç å·æ¡† */ .log-row select:nth-child(3) { padding-left: 0px; text-align-last: left !important; } /* ç­‰çº§é€‰æ‹© */ .log-row input:nth-child(4) { padding-left: 6px; text-align: left !important; } /* é•¿åº¦æ¡† */ .log-row input:nth-child(5) { padding-left: 20px; text-align: left !important; } /* ç›´å¾„æ¡† */
    .log-row:nth-child(even) { background: #222; }
    .log-row.dimmed { opacity: 0.2; }
    .log-row.highlighted { border: 1px solid var(--accent-color); background-color: #333; }
    .log-row input, .log-row select { 
    height: 34px; 
    font-size: 13px; 
    border: none; 
    background: transparent; 
    text-align: center; 
    width: 100%; /* ç¡®ä¿å¡«æ»¡æ ¼å­ */
    padding: 0;  /* æ¸…é™¤å†…è¾¹è·,ç»™æ–‡å­—ç•™ç©ºé—´ */
}
/* ä¸“é—¨é’ˆå¯¹ä¸‹æ‹‰æ¡†çš„ Safari ä¿®å¤ */
.log-row select { 
    color: #fff; 
    font-weight: bold; 
    -webkit-appearance: none; /* å¿…é¡»:å¼ºåˆ¶å»æ‰ Safari é»˜è®¤çš„ä¸‹æ‹‰ç®­å¤´ */
    appearance: none;          /* å»æ‰æ ‡å‡†æµè§ˆå™¨çš„é»˜è®¤ç®­å¤´ */
    text-align-last: center;   /* ç¡®ä¿ iOS Safari é€‰ä¸­çš„æ–‡å­—æ°´å¹³å±…ä¸­ */
}
    .row-index { color: #666; font-size: 12px; text-align: center; }
    .log-row input:nth-child(2), .log-row input:nth-child(7) { text-align: left; }
    .col-vol { color: var(--accent-color); font-weight: bold; font-family: monospace; text-align: center; font-size: 12px; 
text-align: left !important; padding-left: 25px !important; }
    
    .btn-del-mini { color: var(--danger-color); background: none; border: none; font-size: 20px; width: 100%; cursor: pointer; }
    .btn-del-mini:active { transform: scale(1.2); }
    .danger-text { color: var(--danger-color) !important; font-weight: bold; }

    .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); z-index: 110; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
    .stats-detail { display: flex; overflow-x: auto; padding: 8px 10px; gap: 8px; font-size: 11px; border-bottom: 1px solid #222; }
    .stat-tag { background: #2a2a2a; padding: 4px 12px; border-radius: 12px; white-space: nowrap; cursor: pointer; border: 1px solid #444; color: #aaa; }
    .stat-tag.active-filter { border-color: var(--accent-color); background: #444; color: #fff; }
    .stats-main { display: flex; justify-content: space-around; padding: 12px 10px; font-weight: bold; align-items: baseline; }
    .stats-main span { font-size: 13px; color: #aaa; }
    .stats-main span strong { font-size: 22px; color: var(--accent-color); margin-left: 6px; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; padding: 20px; flex-direction: column; justify-content: center; backdrop-filter: blur(5px); }
    .modal-card { background: #222; padding: 20px; border-radius: 12px; border: 1px solid #444; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .modal-title { font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    
    .info-row { margin-bottom: 15px; }
    .info-row label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
    .info-controls { display: flex; gap: 8px; }
    .btn-tool { background: #333; border: 1px solid #444; color: #ccc; width: 44px; height: 38px; border-radius: 6px; border: none; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .btn-tool:active { background: #555; }
    .btn-block { width: 100%; height: 45px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    .toggle-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 10px; display: flex; align-items: center; gap: 5px; }
    .toggle-btn.active { background: var(--active-mode); color: white; border-color: var(--active-mode); }

    .setting-group { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333; }
    .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .setting-label { color: #ddd; font-size: 14px; }
    .setting-input { width: 80px; text-align: center; font-weight: bold; color: var(--accent-color); }
    
    .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(16px); }

    :root { --pro-kb-height: 350px; }
    body.pro-kb-enabled { padding-bottom: calc(var(--pro-kb-height) + env(safe-area-inset-bottom)); }
    body.pro-kb-enabled .log-card { display: none; }

    .pro-kb { 
        position: fixed; 
        left: 0; 
        right: 0; 
        bottom: 0; 
        height: var(--pro-kb-height); 
        background: #151515; 
        border-top: 2px solid var(--accent-color); 
        z-index: 130; 
        display: none; 
        box-shadow: 0 -6px 20px rgba(0,0,0,0.6);
        padding-bottom: env(safe-area-inset-bottom);
    }
    body.pro-kb-enabled .pro-kb { display: block; }
    .pro-kb-top { display: grid; gap: 8px; padding: 10px; background: #1b1b1b; border-bottom: 1px solid #2a2a2a; }
    .pro-kb-top.three { grid-template-columns: repeat(3, 1fr); }
    .pro-kb-top.four { grid-template-columns: repeat(4, 1fr); }
    .kb-field { background: #1f1f1f; border: 1px solid #333; border-radius: 6px; padding: 6px 8px; cursor: pointer; }
    .kb-field-label { font-size: 10px; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
    .kb-field-value { font-size: 18px; font-weight: bold; color: #fff; min-height: 20px; }
    .kb-field.active { border-color: var(--gold-highlight); box-shadow: 0 0 8px rgba(255,215,0,0.6); }

    .pro-kb-note { display: none; padding: 6px 10px; border-bottom: 1px solid #2a2a2a; background: #181818; }
    .pro-kb-note.visible { display: flex; justify-content: space-between; align-items: center; }
    .pro-kb-note-label { color: #777; font-size: 10px; text-transform: uppercase; letter-spacing: 0.4px; }
    .pro-kb-note-value { color: #ddd; font-size: 13px; max-width: 75%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .pro-kb-note.active { border-bottom: 1px solid var(--gold-highlight); }

    .pro-kb-body { display: grid; grid-template-columns: 1.1fr 3fr 1.1fr; gap: 8px; padding: 10px; height: calc(var(--pro-kb-height) - 80px); }
    .kb-side { display: grid; grid-template-rows: repeat(4, 1fr); gap: 8px; }
    .kb-side-btn { background: #1f1f1f; border: 1px solid #333; color: #c9c1b8; border-radius: 8px; font-weight: bold; font-size: 12px; letter-spacing: 0.5px; }
    .kb-side-btn.active { border-color: var(--gold-highlight); color: #fff; box-shadow: 0 0 8px rgba(255,215,0,0.4); }
    .kb-side-btn.disabled { opacity: 0.4; pointer-events: none; }

    .kb-core { display: grid; }
    .kb-num-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(4, 1fr); gap: 8px; height: 100%; }
    .kb-grade-grid { display: none; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 8px; height: 100%; }
    .kb-core.grade-mode .kb-num-grid { display: none; }
    .kb-core.grade-mode .kb-grade-grid { display: grid; }

    .kb-key { background: #202020; border: 1px solid #333; color: #eee; border-radius: 10px; font-size: 18px; font-weight: bold; }
    .kb-key.gold { border-color: var(--accent-color); color: #000; background: var(--accent-color); }
    .kb-key.small { font-size: 14px; }
    .kb-grade-key.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }

    .kb-ops { display: grid; grid-template-rows: 1fr 3fr; gap: 8px; }
    .kb-del { background: #2a2a2a; border: 1px solid #444; color: #eee; font-weight: bold; border-radius: 10px; }
    .kb-ok { background: var(--accent-color); color: #000; font-size: 22px; font-weight: bold; border: none; border-radius: 12px; }

    .pro-kb button:active { transform: scale(0.96); filter: brightness(1.1); }

    .price-settings-box { margin-top: 10px; }
    .price-grade-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; width: 100%; }
    .price-grade-item { display:flex; align-items:center; gap:6px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; min-width: 0; }
    .price-grade-item input { min-width: 0; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header class="header">
    <div style="display: flex; gap: 10px;">
        <button class="btn-header btn-reset" onclick="resetLogOnly()" data-i18n="btn_new">âŸ³ æ–°æŸœ</button>
        <button class="btn-header btn-info" onclick="openInfoModal()" data-i18n="btn_info">ğŸ“‹ ä¿¡æ¯</button>
        <button class="btn-header btn-info" onclick="openSettingsModal()" data-i18n="btn_settings">âš™ï¸ è®¾ç½®</button>
    </div>
    <div style="display: flex;">
        <button class="btn-header btn-pdf" onclick="generatePDF()" data-i18n="btn_pdf">PDF</button>
        <button class="btn-header btn-export" onclick="exportData()" data-i18n="btn_excel">å¯¼å‡º Excel</button>
    </div>
</header>

<div id="logList"></div>

<div id="proKeyboard" class="pro-kb">
    <div id="proKbTop" class="pro-kb-top three"></div>
    <div id="proKbNote" class="pro-kb-note" onclick="setProActiveField('note')">
        <span class="pro-kb-note-label" data-i18n="note">å¤‡æ³¨</span>
        <span class="pro-kb-note-value" id="proNoteValue"></span>
    </div>
    <div class="pro-kb-body">
        <div class="kb-side">
            <button class="kb-side-btn" id="kbSideLen" onclick="handleProSide('len')" data-i18n="kb_len_btn">LEN/é•¿åº¦</button>
            <button class="kb-side-btn" id="kbSideDia" onclick="handleProSide('dia')" data-i18n="kb_dia_btn">DIA/ç›´å¾„</button>
            <button class="kb-side-btn" id="kbSideGrd" onclick="handleProSide('grd')" data-i18n="kb_grd_btn">GRD/ç­‰çº§</button>
            <button class="kb-side-btn" id="kbSideNote" onclick="handleProSide('note')" data-i18n="kb_note_btn">NOTE/å¤‡æ³¨</button>
        </div>
        <div class="kb-core" id="kbCore">
            <div class="kb-num-grid">
                <button class="kb-key" onclick="handleProKey('7')">7</button>
                <button class="kb-key" onclick="handleProKey('8')">8</button>
                <button class="kb-key" onclick="handleProKey('9')">9</button>
                <button class="kb-key" onclick="handleProKey('4')">4</button>
                <button class="kb-key" onclick="handleProKey('5')">5</button>
                <button class="kb-key" onclick="handleProKey('6')">6</button>
                <button class="kb-key" onclick="handleProKey('1')">1</button>
                <button class="kb-key" onclick="handleProKey('2')">2</button>
                <button class="kb-key" onclick="handleProKey('3')">3</button>
                <button class="kb-key" onclick="handleProKey('0')">0</button>
                <button class="kb-key" onclick="handleProKey('.')">.</button>
                <button class="kb-key small" onclick="handleProNext()" data-i18n="kb_next">NXT</button>
            </div>
            <div class="kb-grade-grid" id="proKbGrade"></div>
        </div>
        <div class="kb-ops">
            <button class="kb-del" onclick="handleProDelete()" data-i18n="kb_del">DEL</button>
            <button class="kb-ok" onclick="handleProOk()" data-i18n="kb_ok">OK</button>
        </div>
    </div>
</div>

<div class="footer">
    <div class="stats-detail" id="statsDetail"></div>
    <div class="stats-main">
        <span><span data-i18n="total_count">æ€»æ•°</span>:<strong id="totalCount">0</strong></span>
        <span><span data-i18n="total_vol">æç§¯</span>:<strong id="totalVol">0.000</strong> mÂ³</span>
    </div>
</div>

<div id="infoModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">
            <span data-i18n="modal_info_title">é¡¹ç›®ä¿¡æ¯</span>
        </div>
        
        <div class="info-row"><label data-i18n="container">é›†è£…ç®±å·</label><div class="info-controls"><input type="text" id="g_container" oninput="updateGlobal()"></div></div>
        <div class="info-row"><label data-i18n="note_global">æ•´å•å¤‡æ³¨</label><div class="info-controls"><input type="text" id="g_note" oninput="updateGlobal()"></div></div>
        <div style="border-bottom: 1px solid #333; margin: 15px 0;"></div>
        <div class="info-row"><label data-i18n="my_company">å…¬å¸åç§°</label><div class="info-controls"><input type="text" id="g_company" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('company')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('company')">ğŸ“–</button></div></div>
        <div class="info-row"><label data-i18n="seller">å–æ–¹å…¬å¸</label><div class="info-controls"><input type="text" id="g_seller" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('seller')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('seller')">ğŸ“–</button></div></div>
        <div class="info-row"><label data-i18n="location">åœ°ç‚¹</label><div class="info-controls"><input type="text" id="g_location" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('location')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('location')">ğŸ“–</button></div></div>
        <div class="info-row"><label data-i18n="measurer">æµ‹é‡äºº</label><div class="info-controls"><input type="text" id="g_measurer" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('measurer')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('measurer')">ğŸ“–</button></div></div>

        <button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="closeInfoModal()" data-i18n="btn_close">å…³é—­</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">âš™ï¸ <span data-i18n="settings_title">è®¾ç½®</span></div>
        <div class="setting-group">
            <div class="setting-row">
                <span class="setting-label" data-i18n="language">è¯­è¨€ / Language</span>
                <select id="langSelect" onchange="changeLanguage(this.value)" style="width:100px; height:30px; font-size:12px;">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="sl">SlovenÅ¡Äina</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label" data-i18n="quick_mode">å¿«é€Ÿæ¨¡å¼</span>
                <button id="quickModeBtn" class="toggle-btn" onclick="toggleQuickMode()">âš¡</button>
            </div>
            <div class="setting-row">
                <span class="setting-label" data-i18n="enable_pro_kb">å¯ç”¨ä¸“ä¸šè™šæ‹Ÿé”®ç›˜</span>
                <label class="switch"><input type="checkbox" id="checkProKeyboard" onchange="toggleProKeyboard()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span class="setting-label"><span data-i18n="show_grade">æ˜¾ç¤ºç­‰çº§</span></span>
                <label class="switch"><input type="checkbox" id="checkShowGrade" checked onchange="toggleGradeDisplay()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span class="setting-label" data-i18n="calc_dia">åŒå¾„æ¨¡å¼ (è®¡ç®—å¹³å‡å€¼)</span>
                <label class="switch"><input type="checkbox" id="checkCalcDia" onchange="toggleCalcDia()"><span class="slider"></span></label>
            </div>
            <div class="setting-row" id="roundModeRow" style="display:none;">
                <span class="setting-label">è¿›ä½æ¨¡å¼ (.5çš„å¤„ç†)</span>
                <select id="roundSelect" onchange="saveSettings()" style="width:100px; height:30px; font-size:12px;">
                    <option value="up">ä¸Šè¿›ä½ (40.5â†’41)</option>
                    <option value="down">ä¸‹èˆå» (40.5â†’40)</option>
                    <option value="mix">æ··åˆ (è½®æµ)</option>
                </select>
            </div>
        </div>
        <div class="setting-group">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;" data-i18n="deduction_desc">è‡ªåŠ¨æ‰£å°º (ä¿å­˜æ—¶è‡ªåŠ¨æ‰£é™¤)</div>
            <div class="setting-row">
                <span class="setting-label"><span data-i18n="len_deduct">é•¿åº¦æ‰£å°º</span> (cm)</span>
                <input type="number" id="setDeductLen" class="setting-input" value="0" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span class="setting-label"><span data-i18n="dia_deduct">ç›´å¾„æ‰£å°º</span> (cm)</span>
                <input type="number" id="setDeductDia" class="setting-input" value="0" onchange="saveSettings()">
            </div>
        </div>
        <div class="setting-group">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;" data-i18n="price_title">ä»·æ ¼è®¾ç½® (æ¯ç«‹æ–¹ç±³)</div>
            <div class="setting-row">
                <span class="setting-label" data-i18n="price_enable">å¯ç”¨ä»·æ ¼è®¡ç®—</span>
                <label class="switch"><input type="checkbox" id="priceEnabled" onchange="togglePriceEnabled()"><span class="slider"></span></label>
            </div>
            <div id="priceSettingsBox" class="price-settings-box">
                <div class="setting-row">
                    <span class="setting-label" data-i18n="price_currency">å¸ç§</span>
                    <select id="priceCurrency" onchange="updateCurrencySymbols(); saveSettings()" style="width:100px; height:30px; font-size:12px;">
                        <option value="EUR">EUR â‚¬</option>
                        <option value="USD">USD $</option>
                        <option value="CNY">CNY Â¥</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label" data-i18n="price_mode">å®šä»·æ–¹å¼</span>
                    <select id="priceMode" onchange="updatePriceModeUI(); saveSettings()" style="width:120px; height:30px; font-size:12px;">
                        <option value="fixed" data-i18n="price_mode_fixed">ç»Ÿä¸€ä»·</option>
                        <option value="grade" data-i18n="price_mode_grade">æŒ‰ç­‰çº§</option>
                    </select>
                </div>
                <div class="setting-row" id="priceFixedRow">
                    <span class="setting-label" data-i18n="price_fixed">ä¸€å£ä»· (æ¯ç«‹æ–¹ç±³)</span>
                    <div style="display: flex; align-items: center; gap: 5px; width: 103px;">
                        <input type="number" id="priceFixed" class="setting-input" value="0" onchange="saveSettings()">
                        <span id="currencySymbolFixed" style="color: var(--accent-color); font-weight: bold; font-size: 16px; min-width: 18px;">â‚¬</span>
                    </div>
                </div>
                <div id="priceGradeBox" style="display:none;">
                    <div class="setting-row" style="align-items:flex-start;">
                        <span class="setting-label" data-i18n="price_by_grade">æŒ‰ç­‰çº§</span>
                        <div class="price-grade-grid">
                            <div class="price-grade-item">
                                <span style="min-width:24px; font-weight: bold; color: #aaa;">F</span>
                                <input type="number" id="price_grade_F" class="setting-input" style="width:100%;" onchange="saveSettings()">
                                <span class="currencySymbolGrade" style="color: var(--accent-color); font-weight: bold; font-size: 14px; min-width: 18px;">â‚¬</span>
                            </div>
                            <div class="price-grade-item">
                                <span style="min-width:24px; font-weight: bold; color: #aaa;">A+</span>
                                <input type="number" id="price_grade_Aplus" class="setting-input" style="width:100%;" onchange="saveSettings()">
                                <span class="currencySymbolGrade" style="color: var(--accent-color); font-weight: bold; font-size: 14px; min-width: 18px;">â‚¬</span>
                            </div>
                            <div class="price-grade-item">
                                <span style="min-width:24px; font-weight: bold; color: #aaa;">A</span>
                                <input type="number" id="price_grade_A" class="setting-input" style="width:100%;" onchange="saveSettings()">
                                <span class="currencySymbolGrade" style="color: var(--accent-color); font-weight: bold; font-size: 14px; min-width: 18px;">â‚¬</span>
                            </div>
                            <div class="price-grade-item">
                                <span style="min-width:24px; font-weight: bold; color: #aaa;">B</span>
                                <input type="number" id="price_grade_B" class="setting-input" style="width:100%;" onchange="saveSettings()">
                                <span class="currencySymbolGrade" style="color: var(--accent-color); font-weight: bold; font-size: 14px; min-width: 18px;">â‚¬</span>
                            </div>
                            <div class="price-grade-item">
                                <span style="min-width:24px; font-weight: bold; color: #aaa;">C</span>
                                <input type="number" id="price_grade_C" class="setting-input" style="width:100%;" onchange="saveSettings()">
                                <span class="currencySymbolGrade" style="color: var(--accent-color); font-weight: bold; font-size: 14px; min-width: 18px;">â‚¬</span>
                            </div>
                            <div class="price-grade-item">
                                <span style="min-width:24px; font-weight: bold; color: #aaa;">D</span>
                                <input type="number" id="price_grade_D" class="setting-input" style="width:100%;" onchange="saveSettings()">
                                <span class="currencySymbolGrade" style="color: var(--accent-color); font-weight: bold; font-size: 14px; min-width: 18px;">â‚¬</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="setting-row">
                    <span class="setting-label" data-i18n="price_tax">ç¨ç‡</span>
                    <div style="display: flex; align-items: center; gap: 5px; width: 103px;">
                        <input type="number" id="priceTax" class="setting-input" value="0" onchange="saveSettings()">
                        <span style="color: var(--accent-color); font-weight: bold; font-size: 16px; min-width: 18px;">%</span>
                    </div>
                </div>
                <div class="setting-row">
                    <span class="setting-label" data-i18n="price_show_pdf">PDFæ˜¾ç¤ºä»·æ ¼</span>
                    <label class="switch"><input type="checkbox" id="priceShowPdf" onchange="saveSettings()"><span class="slider"></span></label>
                </div>
                <div class="setting-row">
                    <span class="setting-label" data-i18n="price_show_excel">Excelæ˜¾ç¤ºä»·æ ¼</span>
                    <label class="switch"><input type="checkbox" id="priceShowCsv" onchange="saveSettings()"><span class="slider"></span></label>
                </div>
            </div>
        </div>
        <button class="btn-block" style="background:#333; color:#fff;" onclick="document.getElementById('settingsModal').style.display='none'" data-i18n="btn_close">å…³é—­</button>
    </div>
</div>

<div id="historyPop" class="modal-overlay" onclick="this.style.display='none'"><div class="modal-card" onclick="event.stopPropagation()"><div class="modal-title" data-i18n="modal_history">å†å²è®°å½•</div><div id="historyList" style="max-height:300px; overflow-y:auto;"></div><button class="btn-block" style="background:#333; color:#fff;" onclick="document.getElementById('historyPop').style.display='none'" data-i18n="btn_close">å…³é—­</button></div></div>

<script>
    let logs = [];
    let globalInfo = { container: '', note: '', seller: '', measurer: '', location: '', company: '' };
    let histories = { container: [], seller: [], measurer: [], location: [], company: [] };
    let appSettings = { 
        deductLen: 0, 
        deductDia: 0, 
        showGrade: true, 
        calcDia: false, 
        roundMode: 'up',
        proKeyboard: false,
        priceEnabled: false,
        priceCurrency: 'EUR',
        priceMode: 'fixed',
        priceFixed: 0,
        priceByGrade: { 'F': 0, 'A+': 0, 'A': 0, 'B': 0, 'C': 0, 'D': 0 },
        taxPercent: 0,
        showPricePdf: false,
        showPriceCsv: false
    };
    let nextRoundUp = true;
    const GRADES = ['F', 'A+', 'A', 'B', 'C', 'D'];
    let activeFilter = null;
    let currentLang = 'zh';
    let isQuickMode = false;
    let proState = {
        activeField: 'length',
        keypadMode: 'num',
        values: { code: '', length: '', dia: '', dia1: '', dia2: '', note: '' }
    };

    const I18N = {
        zh: { btn_new: "âŸ³ æ–°æŸœ", btn_info: "ğŸ“‹ ä¿¡æ¯", btn_settings: "âš™ï¸ è®¾ç½®", btn_pdf: "PDF", btn_excel: "å¯¼å‡º Excel", container: "é›†è£…ç®±å·", note_global: "æ•´å•å¤‡æ³¨", seller: "å–æ–¹å…¬å¸", measurer: "æµ‹é‡äºº", location: "åœ°ç‚¹", my_company: "å…¬å¸åç§°", code: "ç å·", grade: "ç­‰çº§", len: "é•¿(m)", dia: "å¾„(cm)", vol: "ä½“ç§¯", note: "å¤‡æ³¨", idx: "åº", inputting: "â— æ­£åœ¨è¾“å…¥", add_next: "+ æ·»åŠ å¹¶ä¸‹ä¸€æ ¹", total_count: "æ€»æ•°", total_vol: "æç§¯", modal_info_title: "é¡¹ç›®ä¿¡æ¯", modal_history: "å†å²è®°å½•", btn_close: "å…³é—­", btn_copy: "å¤åˆ¶å†…å®¹", p_date: "æ—¥æœŸ", select_grade: "é€‰æ‹©ç­‰çº§", quick_on: "âš¡ å¿«é€Ÿæ¨¡å¼: å¼€", quick_off: "âš¡ å¿«é€Ÿæ¨¡å¼: å…³", quick_mode: "å¿«é€Ÿæ¨¡å¼", settings_title: "è®¾ç½®", language: "è¯­è¨€ / Language", show_grade: "æ˜¾ç¤ºç­‰çº§æŒ‰é’®", enable_pro_kb: "å¯ç”¨ä¸“ä¸šè™šæ‹Ÿé”®ç›˜", len_deduct: "é•¿åº¦æ‰£å‡", dia_deduct: "ç›´å¾„æ‰£å‡", deduction_desc: "è‡ªåŠ¨æ‰£å‡ (å•ä½: å˜ç±³)", calc_dia: "åŒå¾„æ¨¡å¼ (è®¡ç®—å¹³å‡å€¼)", price_title: "ä»·æ ¼è®¾ç½® (æ¯ç«‹æ–¹ç±³)", price_enable: "å¯ç”¨ä»·æ ¼è®¡ç®—", price_currency: "å¸ç§", price_mode: "å®šä»·æ–¹å¼", price_mode_fixed: "ç»Ÿä¸€ä»·", price_mode_grade: "æŒ‰ç­‰çº§", price_fixed: "ä¸€å£ä»· (æ¯ç«‹æ–¹ç±³)", price_by_grade: "æŒ‰ç­‰çº§", price_tax: "ç¨ç‡", price_show_pdf: "PDFæ˜¾ç¤ºä»·æ ¼", price_show_excel: "Excelæ˜¾ç¤ºä»·æ ¼", price_unit: "å•ä»·", price_amount: "é‡‘é¢", price_total: "æ€»é‡‘é¢", kb_len_btn: "LEN/é•¿åº¦", kb_dia_btn: "DIA/ç›´å¾„", kb_grd_btn: "GRD/ç­‰çº§", kb_note_btn: "NOTE/å¤‡æ³¨", kb_del: "DEL", kb_ok: "OK", kb_next: "NXT", kb_code: "ç å·", kb_len: "é•¿åº¦", kb_dia: "ç›´å¾„", kb_dia1: "ç›´å¾„1", kb_dia2: "ç›´å¾„2" },
        en: { btn_new: "âŸ³ Reset", btn_info: "ğŸ“‹ Info", btn_settings: "âš™ï¸ Settings", btn_pdf: "PDF", btn_excel: "Export Excel", container: "Container", note_global: "Global Note", seller: "Seller", measurer: "Measurer", location: "Location", my_company: "Company", code: "Code", grade: "Grade", len: "L(m)", dia: "D(cm)", vol: "Vol", note: "Note", idx: "#", inputting: "â— Inputting", add_next: "+ Add & Next", total_count: "Count", total_vol: "Volume", modal_info_title: "Project Info", modal_history: "History", btn_close: "Close", btn_copy: "Copy All", p_date: "Date", select_grade: "Select Grade", quick_on: "âš¡ Quick Mode: ON", quick_off: "âš¡ Quick Mode: OFF", quick_mode: "Quick Mode", settings_title: "Settings", language: "Language", show_grade: "Show Grades", enable_pro_kb: "Enable Pro Virtual Keyboard", len_deduct: "Len Deduct", dia_deduct: "Dia Deduct", deduction_desc: "Auto Deduction (Unit: cm)", calc_dia: "Dual Dia Mode (Average)", price_title: "Pricing (per mÂ³)", price_enable: "Enable Price Calculation", price_currency: "Currency", price_mode: "Pricing Mode", price_mode_fixed: "Fixed Price", price_mode_grade: "By Grade", price_fixed: "Fixed Price (per mÂ³)", price_by_grade: "By Grade", price_tax: "Tax", price_show_pdf: "Show price in PDF", price_show_excel: "Show price in Excel", price_unit: "Unit Price", price_amount: "Amount", price_total: "Total Amount", kb_len_btn: "LEN", kb_dia_btn: "DIA", kb_grd_btn: "GRD", kb_note_btn: "NOTE", kb_del: "DEL", kb_ok: "OK", kb_next: "NXT", kb_code: "Code", kb_len: "Length", kb_dia: "Dia", kb_dia1: "Dia1", kb_dia2: "Dia2" },
        sl: { btn_new: "âŸ³ Nov", btn_info: "ğŸ“‹ Info", btn_settings: "âš™ï¸ Nastavitve", btn_pdf: "PDF", btn_excel: "Izvozi Excel", container: "Kontejner", note_global: "Opomba", seller: "Prodajalec", measurer: "Merilec", location: "Lokacija", my_company: "Podjetje", code: "Å t.", grade: "Razred", len: "D(m)", dia: "P(cm)", vol: "Vol", note: "Opomba", idx: "#", inputting: "â— Vnos", add_next: "+ Dodaj", total_count: "KoliÄina", total_vol: "Volumen", modal_info_title: "Podatki", modal_history: "Zgodovina", btn_close: "Zapri", btn_copy: "Kopiraj", p_date: "Datum", select_grade: "Izberi Razred", quick_on: "âš¡ Hitro: ON", quick_off: "âš¡ Hitro: OFF", quick_mode: "Hitri naÄin", settings_title: "Nastavitve", language: "Jezik", show_grade: "PrikaÅ¾i Razrede", enable_pro_kb: "Profesionalna tipkovnica", len_deduct: "Odbitek DolÅ¾ine", dia_deduct: "Odbitek Premera", deduction_desc: "Samodejni odbitek (cm)", calc_dia: "Dvojni premer (PovpreÄje)", price_title: "Cene (na mÂ³)", price_enable: "Vklopi izraÄun cene", price_currency: "Valuta", price_mode: "NaÄin cene", price_mode_fixed: "Enotna cena", price_mode_grade: "Po razredu", price_fixed: "Enotna cena (na mÂ³)", price_by_grade: "Po razredu", price_tax: "Davek", price_show_pdf: "Cena v PDF", price_show_excel: "Cena v Excel", price_unit: "Cena", price_amount: "Znesek", price_total: "Skupni znesek", kb_len_btn: "LEN/DOL", kb_dia_btn: "DIA/PRE", kb_grd_btn: "GRD", kb_note_btn: "OPOMBA", kb_del: "DEL", kb_ok: "OK", kb_next: "NXT", kb_code: "Å t.", kb_len: "DolÅ¾ina", kb_dia: "Premer", kb_dia1: "Premer1", kb_dia2: "Premer2" }
    };

    const STORAGE_KEY = 'oak_v286_data';
    const HIST_KEY = 'oak_v286_hist';
    const LANG_KEY = 'oak_v286_lang';
    const QUICK_KEY = 'oak_v286_quick';
    const SETTINGS_KEY = 'oak_v286_settings';
    const MIX_STATE_KEY = 'oak_v286_mix';

    window.onload = () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if(savedData) {
            const p = JSON.parse(savedData);
            logs = p.logs || [];
            globalInfo = p.global || globalInfo;
            ['container', 'note', 'seller', 'measurer', 'location', 'company'].forEach(k => {
                const el = document.getElementById('g_'+k);
                if(el) el.value = globalInfo[k] || '';
            });
        }
        const savedHist = localStorage.getItem(HIST_KEY);
        if(savedHist) histories = JSON.parse(savedHist);
        ['container', 'seller', 'measurer', 'location', 'company'].forEach(k => { if(!histories[k]) histories[k] = []; });

        const savedLang = localStorage.getItem(LANG_KEY);
        if(savedLang) { currentLang = savedLang; document.getElementById('langSelect').value = currentLang; }
        
        const savedQuick = localStorage.getItem(QUICK_KEY);
        if(savedQuick === 'true') { isQuickMode = true; }

        const savedSet = localStorage.getItem(SETTINGS_KEY);
        if(savedSet) { appSettings = Object.assign(appSettings, JSON.parse(savedSet)); }

        if(!appSettings.priceByGrade) appSettings.priceByGrade = {};
        GRADES.forEach(g => { if(appSettings.priceByGrade[g] === undefined) appSettings.priceByGrade[g] = 0; });
        if(appSettings.priceEnabled === undefined) {
            const hasPrice = (parseFloat(appSettings.priceFixed) || 0) > 0 ||
                (parseFloat(appSettings.taxPercent) || 0) > 0 ||
                GRADES.some(g => (parseFloat(appSettings.priceByGrade[g]) || 0) > 0);
            appSettings.priceEnabled = hasPrice;
        }
        
        const savedMix = localStorage.getItem(MIX_STATE_KEY);
        if(savedMix) { nextRoundUp = (savedMix === 'true'); }

        document.getElementById('setDeductLen').value = appSettings.deductLen || 0;
        document.getElementById('setDeductDia').value = appSettings.deductDia || 0;
        document.getElementById('checkShowGrade').checked = appSettings.showGrade;
        document.getElementById('checkCalcDia').checked = appSettings.calcDia || false;
        document.getElementById('checkProKeyboard').checked = !!appSettings.proKeyboard;
        document.getElementById('priceEnabled').checked = !!appSettings.priceEnabled;
        document.getElementById('roundSelect').value = appSettings.roundMode || 'up';
        document.getElementById('priceCurrency').value = appSettings.priceCurrency || 'EUR';
        document.getElementById('priceMode').value = appSettings.priceMode || 'fixed';
        document.getElementById('priceFixed').value = appSettings.priceFixed || 0;
        document.getElementById('priceTax').value = appSettings.taxPercent || 0;
        document.getElementById('priceShowPdf').checked = !!appSettings.showPricePdf;
        document.getElementById('priceShowCsv').checked = !!appSettings.showPriceCsv;
        document.getElementById('price_grade_F').value = appSettings.priceByGrade['F'] || 0;
        document.getElementById('price_grade_Aplus').value = appSettings.priceByGrade['A+'] || 0;
        document.getElementById('price_grade_A').value = appSettings.priceByGrade['A'] || 0;
        document.getElementById('price_grade_B').value = appSettings.priceByGrade['B'] || 0;
        document.getElementById('price_grade_C').value = appSettings.priceByGrade['C'] || 0;
        document.getElementById('price_grade_D').value = appSettings.priceByGrade['D'] || 0;

        applyLanguage();
        updateQuickBtnUI();
        toggleCalcDia(); 
        updatePriceModeUI();
        updatePriceEnabledUI();
        updateCurrencySymbols();
        applyProKeyboardUI();
        if(logs.length === 0) addNewLog();
        renderAll();
    };

    function changeLanguage(lang) { currentLang = lang; localStorage.setItem(LANG_KEY, lang); applyLanguage(); renderAll(); updateQuickBtnUI(); }
    function applyLanguage() {
        const texts = I18N[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(texts[key]) el.innerText = texts[key]; });
        renderProKeyboardTopBar();
        updateProNoteBar();
        renderProGradePanel();
    }
    function updateGlobal() { ['container', 'note', 'seller', 'measurer', 'location', 'company'].forEach(k => { globalInfo[k] = document.getElementById('g_'+k).value; }); save(); }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ logs, global: globalInfo })); updateStats(); }
    function saveSettings() {
        appSettings.deductLen = parseFloat(document.getElementById('setDeductLen').value) || 0;
        appSettings.deductDia = parseFloat(document.getElementById('setDeductDia').value) || 0;
        appSettings.roundMode = document.getElementById('roundSelect').value;
        appSettings.proKeyboard = document.getElementById('checkProKeyboard').checked;
        appSettings.priceEnabled = document.getElementById('priceEnabled').checked;
        appSettings.priceCurrency = document.getElementById('priceCurrency').value;
        appSettings.priceMode = document.getElementById('priceMode').value;
        appSettings.priceFixed = parseFloat(document.getElementById('priceFixed').value) || 0;
        appSettings.taxPercent = parseFloat(document.getElementById('priceTax').value) || 0;
        appSettings.showPricePdf = document.getElementById('priceShowPdf').checked;
        appSettings.showPriceCsv = document.getElementById('priceShowCsv').checked;
        appSettings.priceByGrade = {
            'F': parseFloat(document.getElementById('price_grade_F').value) || 0,
            'A+': parseFloat(document.getElementById('price_grade_Aplus').value) || 0,
            'A': parseFloat(document.getElementById('price_grade_A').value) || 0,
            'B': parseFloat(document.getElementById('price_grade_B').value) || 0,
            'C': parseFloat(document.getElementById('price_grade_C').value) || 0,
            'D': parseFloat(document.getElementById('price_grade_D').value) || 0
        };
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
    }
    function toggleGradeDisplay() {
        appSettings.showGrade = document.getElementById('checkShowGrade').checked;
        saveSettings();
        renderAll();
        updateProSideState();
        if(!appSettings.showGrade && proState.keypadMode === 'grade') setProKeypadMode('num');
    }
    function toggleProKeyboard() {
        appSettings.proKeyboard = document.getElementById('checkProKeyboard').checked;
        saveSettings();
        applyProKeyboardUI();
        renderAll();
    }
    function toggleCalcDia() {
        appSettings.calcDia = document.getElementById('checkCalcDia').checked;
        document.getElementById('roundModeRow').style.display = appSettings.calcDia ? 'flex' : 'none';
        saveSettings();
        renderAll();
        if(appSettings.proKeyboard) {
            proState.values.dia1 = '';
            proState.values.dia2 = '';
        }
        renderProKeyboardTopBar();
        updateProSideState();
    }

    function updatePriceModeUI() {
        const mode = document.getElementById('priceMode').value;
        const fixedRow = document.getElementById('priceFixedRow');
        const gradeBox = document.getElementById('priceGradeBox');
        if(fixedRow) fixedRow.style.display = mode === 'fixed' ? 'flex' : 'none';
        if(gradeBox) gradeBox.style.display = mode === 'grade' ? 'block' : 'none';
    }
    function updatePriceEnabledUI() {
        const enabled = document.getElementById('priceEnabled').checked;
        const box = document.getElementById('priceSettingsBox');
        if(box) box.style.display = enabled ? 'block' : 'none';
    }
    function togglePriceEnabled() { saveSettings(); updatePriceEnabledUI(); }
    
    function openSettingsModal() { document.getElementById('settingsModal').style.display='flex'; }
    function cleanInput(val) { if(!val) return ''; return val.replace(/,/g, '.').replace(/[^0-9.]/g, ''); }
    function autoFixInput(input) {
        let val = input.value;
        if(val.includes(',')) {
            input.value = val.replace(/,/g, '.');
            const id = input.getAttribute('data-id');
            const field = input.getAttribute('data-field');
            if(id && field) updateItem(parseInt(id), field, input.value);
        }
    }

    function getCurrencySymbol() {
        if(appSettings.priceCurrency === 'EUR') return 'â‚¬';
        if(appSettings.priceCurrency === 'USD') return '$';
        if(appSettings.priceCurrency === 'CNY') return 'Â¥';
        return appSettings.priceCurrency || '';
    }
    function updateCurrencySymbols() {
        const symbol = getCurrencySymbol();
        const fixedSymbol = document.getElementById('currencySymbolFixed');
        if(fixedSymbol) fixedSymbol.innerText = symbol;
        document.querySelectorAll('.currencySymbolGrade').forEach(el => el.innerText = symbol);
    }
    function getUnitPriceForLog(log) {
        if(appSettings.priceMode === 'grade') {
            const p = appSettings.priceByGrade[log.grade];
            return parseFloat(p) || 0;
        }
        return parseFloat(appSettings.priceFixed) || 0;
    }
    function calcLogAmountBeforeTax(log) {
        const unit = getUnitPriceForLog(log);
        const v = parseFloat(log.volume) || 0;
        return unit * v;
    }
    function formatMoney(n) { return (isNaN(n) ? '' : n.toFixed(2)); }

    function toggleQuickMode() { isQuickMode = !isQuickMode; localStorage.setItem(QUICK_KEY, isQuickMode); updateQuickBtnUI(); }
    function updateQuickBtnUI() {
        const btn = document.getElementById('quickModeBtn');
        const t = I18N[currentLang];
        if(isQuickMode) { btn.classList.add('active'); btn.innerText = t.quick_on; }
        else { btn.classList.remove('active'); btn.innerText = t.quick_off; }
    }

    function getActiveLog() { return logs.length > 0 ? logs[0] : null; }
    function applyProKeyboardUI() {
        document.body.classList.toggle('pro-kb-enabled', !!appSettings.proKeyboard);
        if(appSettings.proKeyboard) {
            renderProKeyboardTopBar();
            syncProStateFromLog();
            updateProNoteBar();
            updateProSideState();
            setProKeypadMode('num');
            setProActiveField(proState.activeField || 'length');
        }
    }
    function renderProKeyboardTopBar() {
        const top = document.getElementById('proKbTop');
        if(!top) return;
        const t = I18N[currentLang];
        const fields = appSettings.calcDia
            ? [
                { key: 'code', label: t.kb_code },
                { key: 'length', label: t.kb_len },
                { key: 'dia1', label: t.kb_dia1 },
                { key: 'dia2', label: t.kb_dia2 }
            ]
            : [
                { key: 'code', label: t.kb_code },
                { key: 'length', label: t.kb_len },
                { key: 'dia', label: t.kb_dia }
            ];
        top.className = `pro-kb-top ${appSettings.calcDia ? 'four' : 'three'}`;
        top.innerHTML = fields.map(f => `
            <div class="kb-field" data-field="${f.key}" onclick="setProActiveField('${f.key}')">
                <div class="kb-field-label">${f.label}</div>
                <div class="kb-field-value" id="kbv-${f.key}"></div>
            </div>
        `).join('');
        if(!fields.some(f => f.key === proState.activeField)) {
            proState.activeField = 'length';
        }
        updateProTopBarValues();
        updateProActiveUI();
    }
    function syncProStateFromLog() {
        const log = getActiveLog();
        if(!log) return;
        proState.values.code = log.code || '';
        proState.values.length = log.length || '';
        proState.values.dia = log.diameter || '';
        proState.values.note = log.note || '';
        updateProTopBarValues();
        updateProNoteBar();
        renderProGradePanel();
    }
    function updateProTopBarValues() {
        const map = {
            code: proState.values.code,
            length: proState.values.length,
            dia: proState.values.dia,
            dia1: proState.values.dia1,
            dia2: proState.values.dia2
        };
        Object.keys(map).forEach(k => {
            const el = document.getElementById('kbv-' + k);
            if(el) el.innerText = map[k] || '';
        });
    }
    function updateProNoteBar() {
        const bar = document.getElementById('proKbNote');
        const val = document.getElementById('proNoteValue');
        if(!bar || !val) return;
        val.innerText = proState.values.note || '';
        const show = proState.activeField === 'note' || (proState.values.note && proState.values.note.trim() !== '');
        bar.classList.toggle('visible', !!show);
        bar.classList.toggle('active', proState.activeField === 'note');
    }
    function updateProSideState() {
        const grdBtn = document.getElementById('kbSideGrd');
        if(grdBtn) grdBtn.classList.toggle('disabled', !appSettings.showGrade);
    }
    function normalizeProField(field) {
        const valid = ['code', 'length', 'dia', 'dia1', 'dia2', 'note'];
        if(!valid.includes(field)) field = 'length';
        if(appSettings.calcDia) {
            if(field === 'dia') field = 'dia1';
        } else {
            if(field === 'dia1' || field === 'dia2') field = 'dia';
        }
        return field;
    }
    function setProActiveField(field) {
        proState.activeField = normalizeProField(field);
        updateProActiveUI();
        updateProNoteBar();
    }
    function updateProActiveUI() {
        document.querySelectorAll('.kb-field').forEach(f => f.classList.remove('active'));
        const activeField = document.querySelector(`.kb-field[data-field="${proState.activeField}"]`);
        if(activeField) activeField.classList.add('active');
        const lenBtn = document.getElementById('kbSideLen');
        const diaBtn = document.getElementById('kbSideDia');
        const noteBtn = document.getElementById('kbSideNote');
        if(lenBtn) lenBtn.classList.toggle('active', proState.activeField === 'length');
        if(diaBtn) diaBtn.classList.toggle('active', ['dia', 'dia1', 'dia2'].includes(proState.activeField));
        if(noteBtn) noteBtn.classList.toggle('active', proState.activeField === 'note');
    }
    function setProKeypadMode(mode) {
        proState.keypadMode = mode;
        const core = document.getElementById('kbCore');
        if(core) core.classList.toggle('grade-mode', mode === 'grade');
        const grdBtn = document.getElementById('kbSideGrd');
        if(grdBtn) grdBtn.classList.toggle('active', mode === 'grade');
        if(mode === 'grade') renderProGradePanel();
    }
    function handleProSide(type) {
        if(type === 'len') { setProActiveField('length'); setProKeypadMode('num'); return; }
        if(type === 'dia') { setProActiveField(appSettings.calcDia ? 'dia1' : 'dia'); setProKeypadMode('num'); return; }
        if(type === 'grd') { if(appSettings.showGrade) setProKeypadMode('grade'); return; }
        if(type === 'note') { setProActiveField('note'); setProKeypadMode('num'); return; }
    }
    function updateProFieldValue(field, value) {
        const log = getActiveLog();
        if(!log) return;
        proState.values[field] = value;
        if(field === 'code') updateItem(log.id, 'code', value);
        if(field === 'length') updateItem(log.id, 'length', value);
        if(field === 'dia') updateItem(log.id, 'diameter', value);
        if(field === 'note') updateItem(log.id, 'note', value);
        updateProTopBarValues();
        updateProNoteBar();
    }
    function handleProKey(ch) {
        const field = proState.activeField;
        if(!field) return;
        if(field === 'code' && ch === '.') return;
        if(['length', 'dia', 'dia1', 'dia2'].includes(field) && ch === '.' && (proState.values[field] || '').includes('.')) return;
        const current = proState.values[field] || '';
        const next = current + ch;
        updateProFieldValue(field, next);
        if(['dia1', 'dia2'].includes(field) && appSettings.calcDia) updateProDualVolume();
        handleProQuickFlow(field);
    }
    function handleProDelete() {
        const field = proState.activeField;
        if(!field) return;
        const current = proState.values[field] || '';
        const next = current.slice(0, -1);
        updateProFieldValue(field, next);
        if(['dia1', 'dia2'].includes(field) && appSettings.calcDia) updateProDualVolume();
    }
    function handleProNext() {
        const field = proState.activeField;
        if(field === 'code') return setProActiveField('length');
        if(field === 'length') return setProActiveField(appSettings.calcDia ? 'dia1' : 'dia');
        if(field === 'dia1') return setProActiveField('dia2');
        if(field === 'dia' || field === 'dia2') return handleProOk();
        if(field === 'note') return setProActiveField('length');
    }
    function handleProOk() { addNewLog(); }
    function handleProQuickFlow(field) {
        if(!isQuickMode) return;
        if(field === 'length') {
            const val = proState.values.length || '';
            if(!/^\d+$/.test(val)) return;
            if(val.length === 2 && val[0] !== '1') {
                updateProFieldValue('length', `${val[0]}.${val[1]}`);
                handleProNext();
                return;
            }
            if(val.length === 3 && val[0] === '1') {
                updateProFieldValue('length', `${val.slice(0,2)}.${val[2]}`);
                handleProNext();
            }
            return;
        }
        if(!['dia', 'dia1', 'dia2'].includes(field)) return;
        const val = proState.values[field] || '';
        if(!/^\d+$/.test(val)) return;
        const shouldJump = (val[0] !== '1' && val.length === 2) || (val[0] === '1' && val.length === 3);
        if(!shouldJump) return;
        if(field === 'dia1') return setProActiveField('dia2');
        if(appSettings.showGrade) return setProKeypadMode('grade');
        handleProNext();
    }
    function updateProDualVolume() {
        const log = getActiveLog();
        if(!log) return;
        const l = parseFloat(cleanInput(log.length.toString())) || 0;
        const d1 = parseFloat(cleanInput((proState.values.dia1 || '').toString())) || 0;
        const d2 = parseFloat(cleanInput((proState.values.dia2 || '').toString())) || 0;
        let usedDia = 0;
        if(d1 > 0 && d2 > 0) usedDia = (d1 + d2) / 2;
        else if(d1 > 0) usedDia = d1;
        if(l > 0 && usedDia > 0) {
            const radius_m = usedDia / 200;
            log.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * l).toFixed(3));
            const vDisplay = document.getElementById('v-'+log.id); if(vDisplay) vDisplay.innerText = log.volume.toFixed(3);
        } else {
            log.volume = 0;
            const vDisplay = document.getElementById('v-'+log.id); if(vDisplay) vDisplay.innerText = '0.000';
        }
        save();
    }
    function renderProGradePanel() {
        const box = document.getElementById('proKbGrade');
        if(!box) return;
        const log = getActiveLog();
        const activeGrade = log ? log.grade : '';
        box.innerHTML = GRADES.map(g => `
            <button class="kb-key kb-grade-key ${activeGrade===g?'active':''}" onclick="selectProGrade('${g}')">${g}</button>
        `).join('');
    }
    function selectProGrade(grade) {
        const log = getActiveLog();
        if(!log) return;
        setGrade(log.id, grade);
        setProKeypadMode('num');
        renderProGradePanel();
    }
    
    function handleQuickLength(input) {
        if (!isQuickMode) return;
        let val = input.value;
        if (!val) return;
        if (val.startsWith('1')) return;

        if (/^\d+$/.test(val)) {
            let num = parseInt(val);
            let newVal = null;
            if (num >= 20 && num <= 99) newVal = (num / 10).toString();
            else if (num >= 101 && num <= 159) newVal = (num / 10).toString();
            if (newVal) {
                input.value = newVal;
                if(logs.length > 0) logs[0].length = newVal;
                updateItem(logs[0].id, 'length', newVal);

                if (appSettings.calcDia) {
                    document.getElementById('in-dia-1').focus();
                } else {
                    const diaInput = document.querySelector(`.log-card .field input[data-field="diameter"]`);
                    if(diaInput) diaInput.focus();
                }
            }
        }
    }

    function handleQuickDiameterSingle(input) {
        if (!isQuickMode) return;
        if (appSettings.showGrade) return;

        const val = input.value;
        if (!val) return;
        
        if (val.length === 2 && /^\d+$/.test(val) && !val.startsWith('1')) { saveAndJumpSingle(val); }
        if (val.length === 3 && /^\d+$/.test(val)) { saveAndJumpSingle(val); }
    }
    function saveAndJumpSingle(val) {
        updateItem(logs[0].id, 'diameter', val);
        setTimeout(() => { 
            addNewLog();
            setTimeout(() => {
                const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                if(lenInput) lenInput.focus(); 
            }, 0);
        }, 150);
    }

    function handleQuickDia1(input) {
        if (!isQuickMode) return;
        const val = input.value;
        if (!val) return;
        if (val.length === 2 && /^\d+$/.test(val)) {
             if (!val.startsWith('1')) {
                 document.getElementById('in-dia-2').focus();
             }
        }
        if (val.length === 3 && /^\d+$/.test(val)) {
            document.getElementById('in-dia-2').focus();
        }
    }

    function handleQuickDia2(input) {
        if (!isQuickMode) return;
        const val = input.value;
        if (!val) return;
        
        let isDone = false;
        if (val.length === 2 && /^\d+$/.test(val) && !val.startsWith('1')) isDone = true;
        if (val.length === 3 && /^\d+$/.test(val)) isDone = true;

        if (isDone) {
            if (appSettings.showGrade) return;
            setTimeout(() => { 
                addNewLog();
                setTimeout(() => {
                    const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                    if(lenInput) lenInput.focus(); 
                }, 0);
            }, 150);
        }
    }

    function calculateDualDia(d1, d2) {
        const avg = (d1 + d2) / 2;
        if (avg % 1 === 0.5) {
            if (appSettings.roundMode === 'up') return Math.ceil(avg);
            if (appSettings.roundMode === 'down') return Math.floor(avg);
            if (appSettings.roundMode === 'mix') {
                const res = nextRoundUp ? Math.ceil(avg) : Math.floor(avg);
                nextRoundUp = !nextRoundUp;
                localStorage.setItem(MIX_STATE_KEY, nextRoundUp);
                return res;
            }
        }
        return Math.round(avg);
    }

    function getNextCode() {
        if(logs.length === 0) return '';
        const match = logs[0].code.match(/^(.*?)(\d+)$/);
        return match ? match[1] + (parseInt(match[2]) + 1).toString().padStart(match[2].length, '0') : logs[0].code;
    }

    function addNewLog() {
        if(logs.length > 0) {
            const current = logs[0];
            
            if(appSettings.calcDia) {
                const usePro = appSettings.proKeyboard;
                const d1 = usePro ? (parseFloat(cleanInput((proState.values.dia1 || '').toString())) || 0) : (parseFloat(document.getElementById('in-dia-1')?.value) || 0);
                const d2 = usePro ? (parseFloat(cleanInput((proState.values.dia2 || '').toString())) || 0) : (parseFloat(document.getElementById('in-dia-2')?.value) || 0);
                if(d1 > 0 && d2 > 0) {
                    const finalDia = calculateDualDia(d1, d2);
                    current.diameter = finalDia.toString();
                } else if (d1 > 0) {
                    current.diameter = d1.toString();
                }
            }

            let rawLen = parseFloat(cleanInput(current.length.toString()));
            let rawDia = parseFloat(cleanInput(current.diameter.toString()));
            let changed = false;

            if(rawLen > 0 && appSettings.deductLen > 0) {
                rawLen = rawLen - (appSettings.deductLen / 100);
                if(rawLen < 0) rawLen = 0;
                current.length = parseFloat(rawLen.toFixed(2)).toString();
                changed = true;
            }
            if(rawDia > 0 && appSettings.deductDia > 0) {
                rawDia = rawDia - appSettings.deductDia;
                if(rawDia < 0) rawDia = 0;
                current.diameter = rawDia.toString(); 
                changed = true;
            }

            if(changed || appSettings.calcDia) {
                const radius_m = rawDia / 200;
                current.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * rawLen).toFixed(3));
            }
        }

        document.querySelectorAll('input').forEach(i => autoFixInput(i));
        const newLog = { id: Date.now(), code: getNextCode(), grade: '', length: '', diameter: '', volume: 0, note: '' };
        logs.unshift(newLog);
        save();
        renderAll();
        activeFilter = null;
        applyFilter();
        
        setTimeout(() => {
            if(appSettings.proKeyboard) {
                proState.values.length = '';
                proState.values.dia = '';
                proState.values.dia1 = '';
                proState.values.dia2 = '';
                syncProStateFromLog();
                setProKeypadMode('num');
                setProActiveField('length');
            } else {
                const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                if(lenInput) { lenInput.focus(); lenInput.click(); }
            }
        }, 10);
    }

    function renderAll() {
        const container = document.getElementById('logList');
        container.innerHTML = '';
        const t = I18N[currentLang];
        if(logs.length > 1) {
            const header = document.createElement('div');
            header.className = 'list-header';
            header.innerHTML = `<div>${t.idx}</div><div>${t.code}</div><div>${t.grade}</div><div>${t.len}</div><div>${t.dia}</div><div>${t.vol}</div><div>${t.note}</div><div></div>`;
            container.appendChild(header);
        }
        logs.forEach((log, index) => {
            const realIndex = logs.length - index;
            if(index === 0) container.insertBefore(createCard(log, realIndex), container.firstChild);
            else container.appendChild(createRow(log, realIndex));
        });
        updateStats();
        if(appSettings.proKeyboard) syncProStateFromLog();
        applyFilter();
    }

    function createCard(log, idx) {
        const t = I18N[currentLang];
        let btnsHtml = '';
        GRADES.forEach(g => {
            const isActive = log.grade === g ? 'active' : '';
            btnsHtml += `<button class="btn-grade ${isActive}" onmousedown="event.preventDefault()" onclick="setGrade(${log.id}, '${g}')">${g}</button>`;
        });

        const gradeDisplayClass = appSettings.showGrade ? '' : 'hidden';

        let diaInputHtml = '';
        if (appSettings.calcDia) {
            diaInputHtml = `
                <div class="double-input-container">
                    <input type="text" inputmode="decimal" id="in-dia-1" oninput="handleQuickDia1(this)">
                    <input type="text" inputmode="decimal" id="in-dia-2" oninput="handleQuickDia2(this)">
                </div>
            `;
        } else {
            diaInputHtml = `
                <input type="text" inputmode="decimal" value="${log.diameter}" data-id="${log.id}" data-field="diameter" oninput="updateItem(${log.id},'diameter',this.value); handleQuickDiameterSingle(this)" onblur="autoFixInput(this)">
            `;
        }

        const div = document.createElement('div');
        div.className = 'log-card';
        div.innerHTML = `
            <div class="card-title"><span>${t.inputting}</span><span>NO. ${idx}</span></div>
            <div class="card-row-1">
                <div class="field"><label>${t.code}</label><input type="text" inputmode="numeric" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)"></div>
                <div class="field"><label>${t.note}</label><input type="text" class="input-note" value="${log.note || ''}" oninput="updateItem(${log.id},'note',this.value)"></div>
            </div>
            <div class="card-row-2">
                <div class="field"><label>${t.len}</label>
                    <input type="text" inputmode="decimal" value="${log.length}" data-id="${log.id}" data-field="length" oninput="updateItem(${log.id},'length',this.value); handleQuickLength(this)" onblur="autoFixInput(this)">
                </div>
                <div class="field"><label>${t.dia}</label>
                    ${diaInputHtml}
                </div>
                <div class="live-vol-display" id="v-${log.id}">${log.volume.toFixed(3)}</div>
            </div>
            <div class="grade-section ${gradeDisplayClass}">
                <div class="grade-label">${t.select_grade}</div>
                <div class="grade-container">${btnsHtml}</div>
            </div>
            <button class="btn-add-inline" onclick="addNewLog()">${t.add_next}</button>
        `;
        return div;
    }

    function createRow(log, idx) {
        let gradeOptions = `<option value="">-</option>`;
        gradeOptions += GRADES.map(g => `<option value="${g}" ${log.grade===g?'selected':''}>${g}</option>`).join('');

        const div = document.createElement('div');
        div.className = 'log-row';
        div.id = 'row-' + log.id;
        div.setAttribute('data-grade', log.grade || '?');
        const len_m = parseFloat(cleanInput(log.length.toString()));
        const d_cm = parseFloat(cleanInput(log.diameter.toString()));
        div.setAttribute('data-len', len_m || 0);
        div.setAttribute('data-dia', d_cm || 0);
        const warnClass = (len_m > 15) ? 'danger-text' : '';

        const displayLen = log.length ? parseFloat(log.length) : '';
        const displayDia = log.diameter ? parseFloat(log.diameter) : '';

        div.innerHTML = `
            <div class="row-index">${idx}</div>
            <input type="text" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)">
            <select onchange="updateItem(${log.id},'grade',this.value)">${gradeOptions}</select>
            <input type="text" id="inp-len-${log.id}" class="${warnClass}" inputmode="decimal" value="${displayLen}" oninput="updateItem(${log.id},'length',this.value)" onblur="autoFixInput(this)">
            <input type="text" inputmode="decimal" value="${displayDia}" oninput="updateItem(${log.id},'diameter',this.value)" onblur="autoFixInput(this)">
            <div class="col-vol" id="v-row-${log.id}">${log.volume.toFixed(3)}</div>
            <input type="text" style="font-size:12px;color:#aaa;text-align:left;" value="${log.note||''}" oninput="updateItem(${log.id},'note',this.value)">
            <button class="btn-del-mini" onclick="delItem(${log.id})">Ã—</button>
        `;
        return div;
    }

    function setGrade(id, grade) {
        updateItem(id, 'grade', grade);
        if (isQuickMode) { 
            addNewLog();
            setTimeout(() => {
                if(!appSettings.proKeyboard) {
                    const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                    if(lenInput) lenInput.focus(); 
                }
            }, 0);
        } 
        else { renderAll(); }
        if(appSettings.proKeyboard) renderProGradePanel();
    }

    function updateItem(id, field, val) {
        const item = logs.find(l => l.id === id);
        item[field] = val;
        
        if(field === 'length' || field === 'diameter') {
            let l_str = item.length.toString().replace(/,/g, '.');
            let d_str = item.diameter.toString().replace(/,/g, '.');
            const l = parseFloat(l_str);
            const d = parseFloat(d_str);
            if (!isNaN(l) && !isNaN(d) && l > 0 && d > 0) {
                const radius_m = d / 200;
                item.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * l).toFixed(3));
            } else { item.volume = 0; }
            const vDisplay = document.getElementById('v-'+id); if(vDisplay) vDisplay.innerText = item.volume.toFixed(3);
            const vRowDisplay = document.getElementById('v-row-'+id); if(vRowDisplay) vRowDisplay.innerText = item.volume.toFixed(3);
            if(field === 'length') {
                const rowLenInput = document.getElementById('inp-len-' + id);
                if(rowLenInput) {
                    if(l > 15) rowLenInput.classList.add('danger-text');
                    else rowLenInput.classList.remove('danger-text');
                }
            }
        }
        
        if(appSettings.calcDia && id === logs[0].id) {
             const usePro = appSettings.proKeyboard;
             const d1 = usePro ? (parseFloat(cleanInput((proState.values.dia1 || '').toString())) || 0) : (parseFloat(document.getElementById('in-dia-1')?.value) || 0);
             const d2 = usePro ? (parseFloat(cleanInput((proState.values.dia2 || '').toString())) || 0) : (parseFloat(document.getElementById('in-dia-2')?.value) || 0);
             if(d1 > 0 && d2 > 0) {
                 const avg = (d1 + d2) / 2;
                 const l = parseFloat(item.length) || 0;
                 if(l > 0) {
                     const r = avg / 200;
                     const v = (Math.PI * Math.pow(r, 2) * l).toFixed(3);
                     item.volume = parseFloat(v);
                     document.getElementById('v-'+id).innerText = v;
                 }
             }
        }
        save();
        if(activeFilter) applyFilter();
    }

    function delItem(id) { if(confirm('Delete?')) { logs = logs.filter(l => l.id !== id); renderAll(); save(); } }

    function resetLogOnly() {
        if(confirm(I18N[currentLang].btn_new + '?')) {
            logs = [];
            globalInfo.container = '';
            document.getElementById('g_container').value = '';
            save();
            location.reload();
        }
    }

    function updateStats() {
        const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
        const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
        document.getElementById('totalCount').innerText = validLogs.length;
        document.getElementById('totalVol').innerText = totalV.toFixed(3);

        const gStats = {};
        let l4 = 0, l25 = 0, d30 = 0;
        validLogs.forEach(l => {
            const g = l.grade || '?';
            gStats[g] = (gStats[g] || 0) + 1;
            const len_m = parseFloat(cleanInput(l.length.toString()));
            const d_cm = parseFloat(cleanInput(l.diameter.toString()));
            if(len_m < 4.0) l4++;
            if(len_m < 2.5) l25++;
            if(d_cm < 30) d30++;
        });

        let html = '';
        const mkTag = (key, label, count) => {
            if(count === 0) return '';
            const isActive = activeFilter === key ? 'active-filter' : '';
            return `<div class="stat-tag ${isActive}" onclick="toggleFilter('${key}')">${label}: <b>${count}</b></div>`;
        };
        for(let g in gStats) if(g!=='?' && g!=='') html += mkTag('g_'+g, g, gStats[g]);
        html += mkTag('l4', '< 4m', l4);
        html += mkTag('l25', '< 2.5m', l25);
        html += mkTag('d30', '< 30cm', d30);
        document.getElementById('statsDetail').innerHTML = html;
    }

    function toggleFilter(key) {
        if(activeFilter === key) activeFilter = null;
        else activeFilter = key;
        updateStats();
        applyFilter();
    }

    function applyFilter() {
        const rows = document.querySelectorAll('.log-row');
        if(!activeFilter) {
            rows.forEach(r => { r.classList.remove('dimmed', 'highlighted'); });
            return;
        }
        rows.forEach(r => {
            let match = false;
            const g = r.getAttribute('data-grade');
            const l = parseFloat(r.getAttribute('data-len'));
            const d = parseFloat(r.getAttribute('data-dia'));
            if(activeFilter.startsWith('g_') && activeFilter === 'g_' + g) match = true;
            else if(activeFilter === 'l4' && l < 4.0) match = true;
            else if(activeFilter === 'l25' && l < 2.5) match = true;
            else if(activeFilter === 'd30' && d < 30) match = true;
            if(match) { r.classList.add('highlighted'); r.classList.remove('dimmed'); }
            else { r.classList.add('dimmed'); r.classList.remove('highlighted'); }
        });
    }

    function openInfoModal() { document.getElementById('infoModal').style.display = 'flex'; }
    function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; updateGlobal(); }

    function togglePrintMode() {
        const body = document.body;
        if (body.classList.contains('print-mode')) {
            body.classList.remove('print-mode');
        } else {
            const d = new Date();
            const dateStr = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
            document.getElementById('p_company').innerText = globalInfo.company;
            document.getElementById('print_row_company').style.display = globalInfo.company ? 'table-row' : 'none';
            document.getElementById('p_date').innerText = dateStr;
            document.getElementById('p_container').innerText = globalInfo.container;
            document.getElementById('p_seller').innerText = globalInfo.seller;
            document.getElementById('p_location').innerText = globalInfo.location;
            document.getElementById('print_row_seller').style.display = (!globalInfo.seller && !globalInfo.location) ? 'none' : 'table-row';
            document.getElementById('p_measurer').innerText = globalInfo.measurer;
            document.getElementById('print_row_measurer').style.display = globalInfo.measurer ? 'table-row' : 'none';
            document.getElementById('p_note').innerText = globalInfo.note;
            document.getElementById('print_row_note').style.display = (!globalInfo.note) ? 'none' : 'table-row';
            body.classList.add('print-mode');
            setTimeout(() => { try { window.print(); } catch(e){} }, 300);
        }
    }

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„éšè—å®¹å™¨æ¥æ¸²æŸ“PDFå†…å®¹
        const pdfContainer = document.createElement('div');
        pdfContainer.style.cssText = 'position:absolute;left:-9999px;width:800px;background:white;padding:40px;';
        document.body.appendChild(pdfContainer);
        
        const t = I18N[currentLang];
        const d = new Date();
        const dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        const timeStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}-${d.getMinutes()}`;
        
        // æ„å»ºHTMLå†…å®¹
        let html = `
            <div style="font-family: Arial, sans-serif; color: #000;">
                <h2 style="text-align:center; margin-bottom:20px; font-size:20px; border-bottom:2px solid #000; padding-bottom:10px;">
                    PACKING LOG LIST / SHIPMENT
                </h2>
                <table style="width:100%; border-collapse:collapse; margin-bottom:20px; font-size:12px;">
        `;
        
        // é¡¹ç›®ä¿¡æ¯ï¼ˆä¸“ä¸šåŒåˆ—å¸ƒå±€ï¼Œè‡ªåŠ¨æ’ç‰ˆï¼Œä¸å‡ºç°ç©ºç™½æ ¼ï¼‰
        const infoItems = [];
        const pushInfo = (label, value) => {
            if(value === undefined || value === null) return;
            const v = String(value).trim();
            if(v === '') return;
            infoItems.push([label, v]);
        };
        const companyValue = (globalInfo.company || '').trim();
        infoItems.push([t.p_date, dateStr]);
        pushInfo(t.container, globalInfo.container);
        pushInfo(t.seller, globalInfo.seller);
        pushInfo(t.location, globalInfo.location);
        pushInfo(t.measurer, globalInfo.measurer);
        pushInfo(t.note_global, globalInfo.note);

        if (companyValue) {
            html += `
                <tr>
                    <td style="border:0.6px solid #999; padding:8px; background:#f7f7f7; width:18%;"><strong>${t.my_company}</strong></td>
                    <td style="border:0.6px solid #999; padding:8px;" colspan="3">${companyValue}</td>
                </tr>
            `;
        }
        for (let i = 0; i < infoItems.length; i += 2) {
            const left = infoItems[i];
            const right = infoItems[i + 1];
            if (right) {
                html += `
                    <tr>
                        <td style="border:0.6px solid #999; padding:8px; background:#f7f7f7; width:18%; font-weight:600;">${left[0]}</td>
                        <td style="border:0.6px solid #999; padding:8px; width:32%;">${left[1]}</td>
                        <td style="border:0.6px solid #999; padding:8px; background:#f7f7f7; width:18%; font-weight:600;">${right[0]}</td>
                        <td style="border:0.6px solid #999; padding:8px; width:32%;">${right[1]}</td>
                    </tr>
                `;
            } else {
                html += `
                    <tr>
                        <td style="border:0.6px solid #999; padding:8px; background:#f7f7f7; width:18%; font-weight:600;">${left[0]}</td>
                        <td style="border:0.6px solid #999; padding:8px;" colspan="3">${left[1]}</td>
                    </tr>
                `;
            }
        }
        
        html += `</table>`;
        
        // åŸæœ¨æ•°æ®è¡¨æ ¼ï¼ˆæ˜¾ç¤ºé‡‘é¢åˆ—ï¼‰
        const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
        const showPricePdf = !!appSettings.showPricePdf;
        const currencySymbol = getCurrencySymbol();
        const amountHeadHtml = showPricePdf 
            ? `<th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.price_amount}</th>`
            : '';
        
        html += `
            <table style="width:100%; border-collapse:collapse; font-size:11px; margin-bottom:20px; color:#222;">
                <thead>
                    <tr style="background:#e9e9e9;">
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.idx}</th>
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.code}</th>
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.grade}</th>
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.len}</th>
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.dia}</th>
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.vol} (mÂ³)</th>
                        ${amountHeadHtml}
                        <th style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:600;">${t.note}</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        [...validLogs].reverse().forEach((log, index) => {
            const len = parseFloat(cleanInput(log.length.toString())) || '';
            const dia = parseFloat(cleanInput(log.diameter.toString())) || '';
            const vol = log.volume ? log.volume.toFixed(3) : '0.000';
            const bgColor = index % 2 === 0 ? '#f7f7f7' : '#ffffff';
            const amount = calcLogAmountBeforeTax(log);
            const amountCellHtml = showPricePdf 
                ? `<td style="border:0.6px solid #999; padding:6px; text-align:center;">${amount ? formatMoney(amount) : ''}</td>`
                : '';
            
            html += `
                <tr style="background:${bgColor};">
                    <td style="border:0.6px solid #999; padding:6px; text-align:center;">${index + 1}</td>
                    <td style="border:0.6px solid #999; padding:6px; text-align:center;">${log.code || ''}</td>
                    <td style="border:0.6px solid #999; padding:6px; text-align:center;">${log.grade || '-'}</td>
                    <td style="border:0.6px solid #999; padding:6px; text-align:center;">${len}</td>
                    <td style="border:0.6px solid #999; padding:6px; text-align:center;">${dia}</td>
                    <td style="border:0.6px solid #999; padding:6px; text-align:center;">${vol}</td>
                    ${amountCellHtml}
                    <td style="border:0.6px solid #999; padding:6px; text-align:left; font-size:10px;">${log.note || ''}</td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        
        // ç»Ÿè®¡æ±‡æ€»
        const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
        const gStats = {};
        let l4 = 0, l25 = 0, d30 = 0;
        
        validLogs.forEach(l => {
            const g = l.grade || '?';
            gStats[g] = (gStats[g] || 0) + 1;
            const len_m = parseFloat(cleanInput(l.length.toString()));
            const dia_cm = parseFloat(cleanInput(l.diameter.toString()));
            if(len_m < 4.0) l4++;
            if(len_m < 2.5) l25++;
            if(dia_cm < 30) d30++;
        });
        
        // ä»·æ ¼æ±‡æ€» - ç‹¬ç«‹çš„6åˆ—è¡¨æ ¼
        if(showPricePdf) {
            const taxPercent = parseFloat(appSettings.taxPercent) || 0;
            let totalBeforeTax = 0;
            let avgUnitPrice = 0;
            validLogs.forEach(l => {
                const unit = getUnitPriceForLog(l);
                const v = parseFloat(l.volume) || 0;
                totalBeforeTax += unit * v;
            });
            if(totalV > 0) avgUnitPrice = totalBeforeTax / totalV;
            
            const taxAmount = taxPercent > 0 ? totalBeforeTax * (taxPercent / 100) : 0;
            const totalAfterTax = totalBeforeTax + taxAmount;
            
            const skupajLabel = currentLang === 'sl' ? 'Skupaj' : (currentLang === 'zh' ? 'æ€»è®¡' : 'Total');
            const taxLabel = currentLang === 'sl' ? 'DDV' : (currentLang === 'zh' ? 'å¢å€¼ç¨' : 'TAX');
            const totalLabel = currentLang === 'sl' ? 'Bruto znesek' : (currentLang === 'zh' ? 'å«ç¨æ€»é¢' : 'Total with Tax');
            
            const gradeLabel = currentLang === 'sl' ? 'Razred' : (currentLang === 'zh' ? 'ç­‰çº§' : 'Grade');
            const kolicinaLabel = currentLang === 'sl' ? 'KoliÄina' : (currentLang === 'zh' ? 'æ•°é‡' : 'Quantity');
            const znesekLabel = currentLang === 'sl' ? 'Znesek' : (currentLang === 'zh' ? 'é‡‘é¢' : 'Amount');
            
            // è®¡ç®—æ¯ä¸ªç­‰çº§çš„è¯¦ç»†ä¿¡æ¯
            const gradeDetails = {};
            validLogs.forEach(l => {
                const g = l.grade || '?';
                if(g === '?' || g === '') return;
                if(!gradeDetails[g]) {
                    gradeDetails[g] = { count: 0, volume: 0, amount: 0 };
                }
                gradeDetails[g].count++;
                gradeDetails[g].volume += parseFloat(l.volume) || 0;
                const unitPrice = getUnitPriceForLog(l);
                const v = parseFloat(l.volume) || 0;
                gradeDetails[g].amount += unitPrice * v;
            });
            
            // åˆ¤æ–­æ˜¯å¦æŒ‰ç­‰çº§å®šä»·
            const isByGrade = appSettings.priceMode === 'grade';
            const totalLabel2 = currentLang === 'sl' ? 'Skupaj' : (currentLang === 'zh' ? 'æ€»è®¡' : 'Total');
            const unitPriceLabel = currentLang === 'sl' ? `Cena (${currencySymbol}/mÂ³)` : (currentLang === 'zh' ? `å•ä»· (${currencySymbol}/mÂ³)` : `Unit Price (${currencySymbol}/mÂ³)`);
            
            // è·å–æ¯ä¸ªç­‰çº§çš„å•ä»·
            const gradeUnitPrices = {};
            GRADES.forEach(g => {
                if(appSettings.priceMode === 'grade') {
                    gradeUnitPrices[g] = parseFloat(appSettings.priceByGrade[g]) || 0;
                } else {
                    gradeUnitPrices[g] = parseFloat(appSettings.priceFixed) || 0;
                }
            });
            
            html += `
                <table style="width:100%; border-collapse:collapse; font-size:11px; margin-top:20px; color:#222;">
                    <thead>
                        <tr style="background:#e9e9e9;">
                            <th style="border:0.6px solid #999; padding:8px; width:20%; text-align:center; font-weight:600;">${gradeLabel}</th>
                            <th style="border:0.6px solid #999; padding:8px; width:20%; text-align:center; font-weight:600;">${kolicinaLabel}</th>
                            <th style="border:0.6px solid #999; padding:8px; width:20%; text-align:center; font-weight:600;">mÂ³</th>
                            <th style="border:0.6px solid #999; padding:8px; width:20%; text-align:center; font-weight:600;">${unitPriceLabel}</th>
                            <th style="border:0.6px solid #999; padding:8px; width:20%; text-align:center; font-weight:600;">${znesekLabel}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // å¦‚æœæŒ‰ç­‰çº§å®šä»·ï¼Œå…ˆæ˜¾ç¤ºç­‰çº§æ˜ç»†
            if(isByGrade) {
                GRADES.forEach(g => {
                    if(gradeDetails[g]) {
                        const detail = gradeDetails[g];
                        const unitPrice = gradeUnitPrices[g] || 0;
                        html += `
                            <tr style="background:#f9f9f9;">
                                <td style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:bold;">${g}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${detail.count}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${detail.volume.toFixed(3)}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(unitPrice)}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(detail.amount)} ${currencySymbol}</td>
                            </tr>
                        `;
                    }
                });
            }
            
            // æ€»è®¡è¡Œ
            html += `
                        <tr style="background:#f0f0f0; font-weight:bold; border-top:2px solid #666;">
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${totalLabel2}</td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${validLogs.length}</td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${totalV.toFixed(3)}</td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(avgUnitPrice)}</td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(totalBeforeTax)} ${currencySymbol}</td>
                        </tr>
            `;
            if(taxPercent > 0) {
                html += `
                        <tr style="background:#f9f9f9;">
                            <td style="border:0.6px solid #999; padding:8px;"></td>
                            <td style="border:0.6px solid #999; padding:8px;"></td>
                            <td style="border:0.6px solid #999; padding:8px;"></td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:right;">${taxLabel} ${taxPercent.toFixed(1)} %</td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(taxAmount)} ${currencySymbol}</td>
                        </tr>
                        <tr style="background:#f0f0f0; font-weight:bold;">
                            <td style="border:0.6px solid #999; padding:8px;"></td>
                            <td style="border:0.6px solid #999; padding:8px;"></td>
                            <td style="border:0.6px solid #999; padding:8px;"></td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:right;">${totalLabel}</td>
                            <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(totalAfterTax)} ${currencySymbol}</td>
                        </tr>
                `;
            }
            
            // å¦‚æœä¸æ˜¯æŒ‰ç­‰çº§å®šä»·ï¼Œåœ¨æœ€åæ˜¾ç¤ºç­‰çº§æ˜ç»†
            if(!isByGrade) {
                GRADES.forEach(g => {
                    if(gradeDetails[g]) {
                        const detail = gradeDetails[g];
                        const unitPrice = gradeUnitPrices[g] || 0;
                        html += `
                            <tr style="background:#f9f9f9;">
                                <td style="border:0.6px solid #999; padding:8px; text-align:center; font-weight:bold;">${g}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${detail.count}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${detail.volume.toFixed(3)}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(unitPrice)}</td>
                                <td style="border:0.6px solid #999; padding:8px; text-align:center;">${formatMoney(detail.amount)} ${currencySymbol}</td>
                            </tr>
                        `;
                    }
                });
            }
            
            html += `
                    </tbody>
                </table>
            `;
        }
        
        // å…¶ä»–ç»Ÿè®¡ä¿¡æ¯
        const summaryTitle = currentLang==='zh'?'ç»Ÿè®¡æ±‡æ€»':(currentLang==='en'?'SUMMARY':'POVZETEK');
        html += `
            <div style="background:#f0f0f0; padding:15px; border:2px solid #000; margin-top:20px;">
                <h3 style="margin:0 0 10px 0; font-size:14px;">${summaryTitle}</h3>
                <p style="margin:5px 0; font-size:12px;">
                    <strong>${t.total_count}:</strong> ${validLogs.length} &nbsp;&nbsp;
                    <strong>${t.total_vol}:</strong> <span style="font-weight:bold;">${totalV.toFixed(3)} mÂ³</span>
                </p>
        `;
        
        if(Object.keys(gStats).length > 0) {
            html += `<p style="margin:5px 0; font-size:11px;"><strong>Grade:</strong> `;
            for(let g in gStats) {
                if(g !== '?' && g !== '') {
                    html += `${g}: ${gStats[g]} &nbsp;&nbsp; `;
                }
            }
            html += `</p>`;
        }
        
        if(l4 > 0 || l25 > 0 || d30 > 0) {
            html += `<p style="margin:5px 0; font-size:10px; color:#666;">`;
            if(l4 > 0) html += `&lt; 4m: ${l4} &nbsp;&nbsp; `;
            if(l25 > 0) html += `&lt; 2.5m: ${l25} &nbsp;&nbsp; `;
            if(d30 > 0) html += `&lt; 30cm: ${d30}`;
            html += `</p>`;
        }
        
        html += `
                <p style="margin:10px 0 0 0; font-size:9px; color:#999; border-top:1px solid #ccc; padding-top:10px;">
                    Oak Master Gold v28.6 | ${dateStr}
                </p>
            </div>
        `;
        
        pdfContainer.innerHTML = html;
        
        // ä½¿ç”¨html2canvasè½¬æ¢ä¸ºå›¾ç‰‡
        try {
            // åŠ¨æ€åŠ è½½html2canvas
            if (!window.html2canvas) {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
            }
            
            const canvas = await html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            });
            
            const imgData = canvas.toDataURL('image/png');
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const imgWidth = 210; // A4å®½åº¦
            const pageHeight = 297; // A4é«˜åº¦
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            
            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            
            const fileName = `OakLog_${globalInfo.container || 'Export'}_${timeStr}.pdf`;
            doc.save(fileName);
            
        } catch (error) {
            console.error('PDF generation error:', error);
            alert('PDF generation failed. Please try again.');
        } finally {
            document.body.removeChild(pdfContainer);
        }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šåŠ¨æ€åŠ è½½è„šæœ¬
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    async function exportData() {
        const d = new Date();
        const timeStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}-${d.getMinutes()}`;
        const ds = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
        const t = I18N[currentLang];
        const showPriceCsv = !!appSettings.showPriceCsv;
        const currencySymbol = getCurrencySymbol();
        const taxPercent = parseFloat(appSettings.taxPercent) || 0;
        
        const wb = XLSX.utils.book_new();
        const wsData = [];
        
        // é¡¹ç›®ä¿¡æ¯ - æ¨ªå‘ä¸“ä¸šå¸ƒå±€
        const infoRow1 = [t.p_date, ds];
        if(globalInfo.company) { infoRow1.push(t.my_company, globalInfo.company); }
        wsData.push(infoRow1);
        
        const infoRow2 = [];
        if(globalInfo.container) { infoRow2.push(t.container, globalInfo.container); }
        if(globalInfo.seller) { infoRow2.push(t.seller, globalInfo.seller); }
        if(infoRow2.length > 0) wsData.push(infoRow2);
        
        const infoRow3 = [];
        if(globalInfo.location) { infoRow3.push(t.location, globalInfo.location); }
        if(globalInfo.measurer) { infoRow3.push(t.measurer, globalInfo.measurer); }
        if(infoRow3.length > 0) wsData.push(infoRow3);
        
        if(globalInfo.note) wsData.push([t.note_global, globalInfo.note]);
        
        wsData.push([]);
        
        // è¡¨å¤´ï¼ˆåŒ…å«é‡‘é¢åˆ—ï¼‰
        const headerRow = [t.idx, t.code, t.grade, t.len, t.dia, t.vol];
        if(showPriceCsv) {
            headerRow.push(t.price_amount);
        }
        headerRow.push(t.note);
        wsData.push(headerRow);
        
        // æ•°æ®è¡Œ
        const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
        let totalBeforeTax = 0;
        [...validLogs].reverse().forEach((l, idx) => {
            const len = parseFloat(cleanInput(l.length.toString())) || '';
            const dia = parseFloat(cleanInput(l.diameter.toString())) || '';
            const vol = l.volume ? parseFloat(l.volume.toFixed(3)) : 0;
            
            const dataRow = [idx + 1, l.code || '', l.grade || '-', len, dia, vol];
            
            // æ·»åŠ é‡‘é¢åˆ—
            if(showPriceCsv) {
                const amount = calcLogAmountBeforeTax(l);
                totalBeforeTax += amount;
                dataRow.push(amount ? parseFloat(amount.toFixed(2)) : '');
            }
            
            dataRow.push(l.note || '');
            wsData.push(dataRow);
        });
        
        // ç»Ÿè®¡æ±‡æ€» - ç‹¬ç«‹çš„6åˆ—è¡¨æ ¼
        wsData.push([]);
        const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
        
        if(showPriceCsv && totalBeforeTax > 0) {
            let avgUnitPrice = totalV > 0 ? totalBeforeTax / totalV : 0;
            const taxAmount = taxPercent > 0 ? totalBeforeTax * (taxPercent / 100) : 0;
            const totalAfterTax = totalBeforeTax + taxAmount;
            
            const gradeLabel = currentLang === 'sl' ? 'Razred' : (currentLang === 'zh' ? 'ç­‰çº§' : 'Grade');
            const kolicinaLabel = currentLang === 'sl' ? 'KoliÄina' : (currentLang === 'zh' ? 'æ•°é‡' : 'Quantity');
            const znesekLabel = currentLang === 'sl' ? 'Znesek' : (currentLang === 'zh' ? 'é‡‘é¢' : 'Amount');
            const taxLabel = currentLang === 'sl' ? 'DDV' : (currentLang === 'zh' ? 'å¢å€¼ç¨' : 'TAX');
            const totalLabel = currentLang === 'sl' ? 'Bruto znesek' : (currentLang === 'zh' ? 'å«ç¨æ€»é¢' : 'Total with Tax');
            
            // è®¡ç®—æ¯ä¸ªç­‰çº§çš„è¯¦ç»†ä¿¡æ¯
            const gradeDetails = {};
            validLogs.forEach(l => {
                const g = l.grade || '?';
                if(g === '?' || g === '') return;
                if(!gradeDetails[g]) {
                    gradeDetails[g] = { count: 0, volume: 0, amount: 0 };
                }
                gradeDetails[g].count++;
                gradeDetails[g].volume += parseFloat(l.volume) || 0;
                const unitPrice = getUnitPriceForLog(l);
                const v = parseFloat(l.volume) || 0;
                gradeDetails[g].amount += unitPrice * v;
            });
            
            // åˆ¤æ–­æ˜¯å¦æŒ‰ç­‰çº§å®šä»·
            const isByGrade = appSettings.priceMode === 'grade';
            const totalLabel2 = currentLang === 'sl' ? 'Skupaj' : (currentLang === 'zh' ? 'æ€»è®¡' : 'Total');
            
            // è·å–æ¯ä¸ªç­‰çº§çš„å•ä»·
            const gradeUnitPrices = {};
            GRADES.forEach(g => {
                if(appSettings.priceMode === 'grade') {
                    gradeUnitPrices[g] = parseFloat(appSettings.priceByGrade[g]) || 0;
                } else {
                    gradeUnitPrices[g] = parseFloat(appSettings.priceFixed) || 0;
                }
            });
            
            // 5åˆ—è¡¨æ ¼ï¼šç­‰çº§ | æ•°é‡ | mÂ³ | å•ä»·(â‚¬/mÂ³) | é‡‘é¢
            // è¡¨å¤´è¡Œ
            wsData.push([]);
            const unitPriceLabel = currentLang === 'sl' ? `Cena (${currencySymbol}/mÂ³)` : (currentLang === 'zh' ? `å•ä»· (${currencySymbol}/mÂ³)` : `Unit Price (${currencySymbol}/mÂ³)`);
            const headerRow = [gradeLabel, kolicinaLabel, 'mÂ³', unitPriceLabel, znesekLabel];
            wsData.push(headerRow);
            
            // å¦‚æœæŒ‰ç­‰çº§å®šä»·ï¼Œå…ˆæ˜¾ç¤ºç­‰çº§æ˜ç»†
            if(isByGrade) {
                GRADES.forEach(g => {
                    if(gradeDetails[g]) {
                        const detail = gradeDetails[g];
                        const unitPrice = gradeUnitPrices[g] || 0;
                        wsData.push([
                            g,
                            detail.count,
                            parseFloat(detail.volume.toFixed(3)),
                            parseFloat(formatMoney(unitPrice)),
                            `${formatMoney(detail.amount)} ${currencySymbol}`
                        ]);
                    }
                });
            }
            
            // æ€»è®¡è¡Œ
            const row1 = [
                totalLabel2,
                validLogs.length,
                parseFloat(totalV.toFixed(3)),
                parseFloat(formatMoney(avgUnitPrice)),
                `${formatMoney(totalBeforeTax)} ${currencySymbol}`
            ];
            wsData.push(row1);
            
            // å¦‚æœæœ‰ç¨æ”¶
            if(taxPercent > 0) {
                // ç¨é¢è¡Œ
                const row2 = ['', '', '', `${taxLabel} ${taxPercent.toFixed(1)} %`, `${formatMoney(taxAmount)} ${currencySymbol}`];
                wsData.push(row2);
                
                // å«ç¨æ€»é¢è¡Œ
                const row3 = ['', '', '', totalLabel, `${formatMoney(totalAfterTax)} ${currencySymbol}`];
                wsData.push(row3);
            }
            
            // å¦‚æœä¸æ˜¯æŒ‰ç­‰çº§å®šä»·ï¼Œåœ¨æœ€åæ˜¾ç¤ºç­‰çº§æ˜ç»†
            if(!isByGrade) {
                GRADES.forEach(g => {
                    if(gradeDetails[g]) {
                        const detail = gradeDetails[g];
                        const unitPrice = gradeUnitPrices[g] || 0;
                        wsData.push([
                            g,
                            detail.count,
                            parseFloat(detail.volume.toFixed(3)),
                            parseFloat(formatMoney(unitPrice)),
                            `${formatMoney(detail.amount)} ${currencySymbol}`
                        ]);
                    }
                });
            }
        } else {
            // ä¸æ˜¾ç¤ºä»·æ ¼æ—¶çš„ç®€å•æ±‡æ€»
            wsData.push([t.total_count, validLogs.length, '', t.total_vol, totalV.toFixed(3) + ' mÂ³']);
        }
        
        // å…¶ä»–ç»Ÿè®¡
        let l4 = 0, l25 = 0, d30 = 0;
        validLogs.forEach(l => {
            const len_m = parseFloat(cleanInput(l.length.toString()));
            const dia_cm = parseFloat(cleanInput(l.diameter.toString()));
            if(len_m < 4.0) l4++; if(len_m < 2.5) l25++; if(dia_cm < 30) d30++;
        });
        
        wsData.push([]);
        if(l4 > 0) wsData.push(['< 4m', l4]);
        if(l25 > 0) wsData.push(['< 2.5m', l25]);
        if(d30 > 0) wsData.push(['< 30cm', d30]);
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // è®¾ç½®åˆ—å®½
        const colWidths = [
            { wch: 6 }, { wch: 16 }, { wch: 8 }, { wch: 10 }, { wch: 10 }, { wch: 12 }
        ];
        if(showPriceCsv) {
            colWidths.push({ wch: 16 }, { wch: 16 });
        }
        colWidths.push({ wch: 25 });
        ws['!cols'] = colWidths;
        
        XLSX.utils.book_append_sheet(wb, ws, 'Oak Logs');
        
        const fileName = `OakLog_${globalInfo.container || 'Export'}_${timeStr}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    function saveToHistory(t){const v=document.getElementById('g_'+t).value.trim();if(v&&!histories[t].includes(v)){histories[t].push(v);localStorage.setItem(HIST_KEY,JSON.stringify(histories));alert('Saved');}}
    function showHistory(t){
        const l=document.getElementById('historyList');l.innerHTML='';
        const items = histories[t] || [];
        if(items.length===0) l.innerHTML='<div style="padding:10px;color:#666;">No Record</div>';
        items.forEach((i,x)=>{
            const d=document.createElement('div');
            d.style.cssText='padding:12px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;';
            d.innerHTML=`<div onclick="selectHistory('${t}','${i}')" style="flex:1;color:#fff;">${i}</div><div onclick="delHistory('${t}',${x})" style="color:red;padding:5px 10px;font-size:18px;">Ã—</div>`;
            l.appendChild(d);
        });
        document.getElementById('historyPop').style.display='flex';
    }
    function selectHistory(t,v){document.getElementById('g_'+t).value=v;globalInfo[t]=v;document.getElementById('historyPop').style.display='none';save();}
    function delHistory(t,i){histories[t].splice(i,1);localStorage.setItem(HIST_KEY,JSON.stringify(histories));showHistory(t);}
</script>
</body>
</html>
