<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Oak Master Gold V28.1</title>
<style>
    :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e0e0e0;
        --accent-color: #d4a373; /* æ©¡æœ¨é‡‘ */
        --gold-highlight: #ffd700;
        --input-bg: #2a2a2a;
        --border-color: #333;
        --danger-color: #ff5252;
        --active-mode: #4caf50;
    }

    /* --- æ‰“å°è¿”å›å›¾æ ‡ --- */
    .print-back-icon {
        display: none; 
        position: fixed; bottom: 40px; right: 30px;
        width: 68px; height: 68px;
        cursor: pointer; z-index: 9999;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    .print-back-icon:active { transform: scale(0.9); }
    .print-back-icon svg { width: 100%; height: 100%; }

    /* --- æ‰“å°/é¢„è§ˆæ¨¡å¼é€»è¾‘ --- */
    @media print {
        .print-back-icon { display: none !important; }
        @page { margin: 0; size: auto; }
        body.print-mode { padding: 1.5cm !important; margin: 0 !important; }
        .header, .log-card, .footer, .btn-del-mini, .modal-overlay, .btn-add-inline, .grade-section { display: none !important; }
    }

    body.print-mode { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
    body.print-mode .header, body.print-mode .log-card, body.print-mode .footer { display: none !important; }
    body.print-mode .print-back-icon { display: block !important; animation: popIn 0.3s ease-out; }
    @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .print-header-table { display: none; width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
    body.print-mode .print-header-table { display: table !important; }
    .print-header-table td { border: 1px solid #000; padding: 5px; color: #000; }

    /* æ‰“å°åˆ—è¡¨ï¼š7åˆ— (æ— åˆ é™¤é”®) */
    body.print-mode .list-header { 
        background: #eee !important; color: black !important; border: 1px solid #000; position: static !important;
        display: grid !important; grid-template-columns: 0.5fr 2fr 0.8fr 0.8fr 0.8fr 1.2fr 2fr !important;
    }
    body.print-mode .list-header div:last-child { display: none !important; }

    body.print-mode .log-row { 
        background: transparent !important; color: black !important; border: 1px solid #000; border-top: none;
        grid-template-columns: 0.5fr 2fr 0.8fr 0.8fr 0.8fr 1.2fr 2fr !important; opacity: 1 !important;
    }
    body.print-mode .btn-del-mini { display: none !important; }

    body.print-mode input, body.print-mode select { 
        color: black !important; background: transparent !important; border: none !important;
        text-align: center; width: 100%; font-weight: normal; appearance: none;
    }
    body.print-mode .col-vol { color: black !important; }
    .print-summary-box { display: none; margin-top: 20px; border: 2px solid #000; padding: 10px; }
    body.print-mode .print-summary-box { display: block !important; }

    /* --- ç¼–è¾‘æ¨¡å¼ --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; padding-bottom: 120px; background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 14px; transition: background-color 0.3s; }

    .header { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; 
              padding: 0 10px; z-index: 100; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .btn-header { padding: 6px 12px; border-radius: 6px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; transition: opacity 0.2s; }
    .btn-info { background: #333; color: #fff; display: flex; align-items: center; gap: 5px; border: 1px solid #444; }
    .btn-export { background: var(--accent-color); color: #000; margin-left: 5px; }
    .btn-pdf { background: #555; color: #fff; margin-left: 5px; }
    .btn-reset { background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); }

    #logList { margin-top: 60px; }

    input, select { background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; height: 38px; border-radius: 4px; padding: 0 8px; font-size: 14px; width: 100%; }
    input:focus, select:focus { border-color: var(--accent-color); outline: none; }

    /* è¡¨å¤´ï¼š8åˆ— */
    .list-header { display: grid; grid-template-columns: 0.5fr 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; padding: 10px; background: #252525; 
                   font-size: 11px; color: #888; position: sticky; top: 50px; z-index: 90; border-bottom: 1px solid #333; }

    .log-card { background: var(--card-bg); margin: 10px; border-radius: 8px; padding: 15px; border: 2px solid var(--accent-color); box-shadow: 0 4px 15px rgba(212,163,115,0.15); }
    .card-title { font-size: 10px; color: var(--accent-color); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; }
    .card-row-1 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .card-row-2 { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 10px; margin-bottom: 15px; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 11px; color: #888; }
    .field input { height: 44px; font-size: 18px; border-color: #555; font-weight: bold; transition: border-color 0.2s; }
    .field input:focus { border-color: var(--accent-color); background: #333; }
    .input-note { font-size: 14px !important; font-weight: normal !important; color: #bbb !important; }
    .live-vol-display { height: 44px; background: rgba(0,0,0,0.3); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--accent-color); font-size: 20px; font-weight: bold; font-family: monospace; border: 1px solid #333; }
    
    /* åŒå¾„è¾“å…¥æ¡†å®¹å™¨ - çº¯å‡€æ— å›¾æ ‡ */
    .double-input-container { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .double-input-container input { text-align: center; font-size: 18px; font-weight: bold; }

    .grade-section { display: block; }
    .grade-section.hidden { display: none; }
    .grade-label { font-size: 11px; color: #888; margin-bottom: 5px; }
    .grade-container { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 15px; }
    .btn-grade { flex: 1; height: 42px; background: #333; border: 1px solid #444; color: #888; border-radius: 6px; font-weight: bold; font-size: 15px; padding: 0; cursor: pointer; transition: all 0.1s; }
    .btn-grade:active { transform: scale(0.95); }
    .btn-grade.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 10px rgba(212,163,115,0.4); }

    .btn-add-inline { width: 100%; height: 50px; background: var(--accent-color); color: #000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-top: 5px; }
    .btn-add-inline:active { transform: scale(0.98); background: #c59363; }

    .log-row { display: grid; grid-template-columns: 0.5fr 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; gap: 4px; padding: 8px 10px; background: var(--card-bg); border-bottom: 1px solid #2a2a2a; align-items: center; }
    .log-row:nth-child(even) { background: #222; }
    .log-row.dimmed { opacity: 0.2; }
    .log-row.highlighted { border: 1px solid var(--accent-color); background-color: #333; }
    .log-row input, .log-row select { height: 34px; font-size: 13px; border: none; background: transparent; text-align: center; }
    .log-row select { color: #fff; font-weight: bold; }
    .row-index { color: #666; font-size: 12px; text-align: center; }
    .log-row input:nth-child(2), .log-row input:nth-child(7) { text-align: left; }
    .col-vol { color: var(--accent-color); font-weight: bold; font-family: monospace; text-align: center; font-size: 12px; }
    
    .btn-del-mini { color: var(--danger-color); background: none; border: none; font-size: 20px; width: 100%; cursor: pointer; }
    .btn-del-mini:active { transform: scale(1.2); }
    .danger-text { color: var(--danger-color) !important; font-weight: bold; }

    .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); z-index: 110; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
    .stats-detail { display: flex; overflow-x: auto; padding: 8px 10px; gap: 8px; font-size: 11px; border-bottom: 1px solid #222; }
    .stat-tag { background: #2a2a2a; padding: 4px 12px; border-radius: 12px; white-space: nowrap; cursor: pointer; border: 1px solid #444; color: #aaa; }
    .stat-tag.active-filter { border-color: var(--accent-color); background: #444; color: #fff; }
    .stats-main { display: flex; justify-content: space-around; padding: 12px 10px; font-weight: bold; align-items: baseline; }
    .stats-main span { font-size: 13px; color: #aaa; }
    .stats-main span strong { font-size: 22px; color: var(--accent-color); margin-left: 6px; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 2000; padding: 20px; flex-direction: column; justify-content: center; backdrop-filter: blur(5px); }
    .modal-card { background: #222; padding: 20px; border-radius: 12px; border: 1px solid #444; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .modal-title { font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    
    .info-row { margin-bottom: 15px; }
    .info-row label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
    .info-controls { display: flex; gap: 8px; }
    .btn-tool { background: #333; border: 1px solid #444; color: #ccc; width: 44px; height: 38px; border-radius: 6px; border: none; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .btn-tool:active { background: #555; }
    .btn-block { width: 100%; height: 45px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    .toggle-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-left: 10px; display: flex; align-items: center; gap: 5px; }
    .toggle-btn.active { background: var(--active-mode); color: white; border-color: var(--active-mode); }

    .setting-group { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333; }
    .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .setting-label { color: #ddd; font-size: 14px; }
    .setting-input { width: 80px; text-align: center; font-weight: bold; color: var(--accent-color); }
    
    .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(16px); }
</style>
</head>
<body>

<div class="print-back-icon" onclick="togglePrintMode()" title="Back">
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <radialGradient id="goldGrad" cx="50%" cy="50%" r="50%" fx="30%" fy="30%">
                <stop offset="0%" style="stop-color:#ffe082; stop-opacity:1" />
                <stop offset="100%" style="stop-color:#d4a373; stop-opacity:1" />
            </radialGradient>
        </defs>
        <circle cx="50" cy="50" r="48" fill="#5D4037" stroke="#3E2723" stroke-width="2"/>
        <circle cx="50" cy="50" r="45" fill="#D7CCC8" />
        <circle cx="50" cy="50" r="42" fill="url(#goldGrad)" />
        <circle cx="50" cy="50" r="34" fill="none" stroke="#b08d55" stroke-width="1.5" opacity="0.6"/>
        <circle cx="50" cy="50" r="6" fill="#8D6E63" />
        <path d="M50 50 L75 68" stroke="#5D4037" stroke-width="1.5" opacity="0.4"/>
    </svg>
</div>

<table class="print-header-table">
    <tr id="print_row_company"><td colspan="4"><span data-i18n="my_company">å…¬å¸</span>: <span id="p_company" style="font-weight:bold;"></span></td></tr>
    <tr><td width="15%"><span data-i18n="p_date">æ—¥æœŸ</span>:</td><td width="35%" id="p_date"></td><td width="15%"><span data-i18n="container">é›†è£…ç®±</span>:</td><td width="35%" id="p_container"></td></tr>
    <tr id="print_row_seller"><td><span data-i18n="seller">å–æ–¹</span>:</td><td id="p_seller"></td><td><span data-i18n="location">åœ°ç‚¹</span>:</td><td id="p_location"></td></tr>
    <tr id="print_row_measurer"><td><span data-i18n="measurer">æµ‹é‡äºº</span>:</td><td id="p_measurer" colspan="3"></td></tr>
    <tr id="print_row_note"><td><span data-i18n="note_global">å¤‡æ³¨</span>:</td><td id="p_note" colspan="3"></td></tr>
</table>

<header class="header">
    <div style="display: flex; gap: 10px;">
        <button class="btn-header btn-reset" onclick="resetLogOnly()" data-i18n="btn_new">âŸ³ æ–°æŸœ</button>
        <button class="btn-header btn-info" onclick="openInfoModal()" data-i18n="btn_info">ğŸ“‹ ä¿¡æ¯</button>
    </div>
    <div style="display: flex;">
        <button class="btn-header btn-pdf" onclick="togglePrintMode()" data-i18n="btn_pdf">PDF</button>
        <button class="btn-header btn-export" onclick="exportData()" data-i18n="btn_excel">å¯¼å‡º</button>
    </div>
</header>

<div id="logList"></div>
<div class="print-summary-box" id="printSummary"></div>

<div class="footer">
    <div class="stats-detail" id="statsDetail"></div>
    <div class="stats-main">
        <span><span data-i18n="total_count">æ€»æ•°</span>:<strong id="totalCount">0</strong></span>
        <span><span data-i18n="total_vol">æç§¯</span>:<strong id="totalVol">0.000</strong> mÂ³</span>
    </div>
</div>

<div id="infoModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">
            <div style="display:flex; align-items:center;">
                <span data-i18n="modal_info_title">é¡¹ç›®ä¿¡æ¯</span>
                <button id="quickModeBtn" class="toggle-btn" onclick="toggleQuickMode()">âš¡</button>
            </div>
            <button class="btn-tool" onclick="openSettingsModal()" style="width:40px;height:30px;font-size:18px;">âš™ï¸</button>
        </div>
        
        <div class="info-row"><label data-i18n="container">é›†è£…ç®±å·</label><div class="info-controls"><input type="text" id="g_container" oninput="updateGlobal()"></div></div>
        <div class="info-row"><label data-i18n="note_global">æ•´å•å¤‡æ³¨</label><div class="info-controls"><input type="text" id="g_note" oninput="updateGlobal()"></div></div>
        <div style="border-bottom: 1px solid #333; margin: 15px 0;"></div>
        <div class="info-row"><label data-i18n="my_company">å…¬å¸åç§°</label><div class="info-controls"><input type="text" id="g_company" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('company')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('company')">ğŸ“–</button></div></div>
        <div class="info-row"><label data-i18n="seller">å–æ–¹å…¬å¸</label><div class="info-controls"><input type="text" id="g_seller" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('seller')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('seller')">ğŸ“–</button></div></div>
        <div class="info-row"><label data-i18n="location">åœ°ç‚¹</label><div class="info-controls"><input type="text" id="g_location" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('location')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('location')">ğŸ“–</button></div></div>
        <div class="info-row"><label data-i18n="measurer">æµ‹é‡äºº</label><div class="info-controls"><input type="text" id="g_measurer" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('measurer')">ğŸ’¾</button><button class="btn-tool" onclick="showHistory('measurer')">ğŸ“–</button></div></div>

        <button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="closeInfoModal()" data-i18n="btn_close">å…³é—­</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-title">âš™ï¸ <span data-i18n="settings_title">è®¾ç½®</span></div>
        
        <div class="setting-group">
            <div class="setting-row">
                <span class="setting-label" data-i18n="language">è¯­è¨€ / Language</span>
                <select id="langSelect" onchange="changeLanguage(this.value)" style="width:100px; height:30px; font-size:12px;">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="sl">SlovenÅ¡Äina</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label"><span data-i18n="show_grade">æ˜¾ç¤ºç­‰çº§</span></span>
                <label class="switch"><input type="checkbox" id="checkShowGrade" checked onchange="toggleGradeDisplay()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span class="setting-label" data-i18n="calc_dia">åŒå¾„æ¨¡å¼ (è®¡ç®—å¹³å‡å€¼)</span>
                <label class="switch"><input type="checkbox" id="checkCalcDia" onchange="toggleCalcDia()"><span class="slider"></span></label>
            </div>
            <div class="setting-row" id="roundModeRow" style="display:none;">
                <span class="setting-label">è¿›ä½æ¨¡å¼ (.5çš„å¤„ç†)</span>
                <select id="roundSelect" onchange="saveSettings()" style="width:100px; height:30px; font-size:12px;">
                    <option value="up">ä¸Šè¿›ä½ (40.5â†’41)</option>
                    <option value="down">ä¸‹èˆå» (40.5â†’40)</option>
                    <option value="mix">æ··åˆ (è½®æµ)</option>
                </select>
            </div>
        </div>

        <div class="setting-group">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;" data-i18n="deduction_desc">è‡ªåŠ¨æ‰£å°º (ä¿å­˜æ—¶è‡ªåŠ¨æ‰£é™¤)</div>
            <div class="setting-row">
                <span class="setting-label"><span data-i18n="len_deduct">é•¿åº¦æ‰£å°º</span> (cm)</span>
                <input type="number" id="setDeductLen" class="setting-input" value="0" onchange="saveSettings()">
            </div>
            <div class="setting-row">
                <span class="setting-label"><span data-i18n="dia_deduct">ç›´å¾„æ‰£å°º</span> (cm)</span>
                <input type="number" id="setDeductDia" class="setting-input" value="0" onchange="saveSettings()">
            </div>
        </div>

        <button class="btn-block" style="background:#333; color:#fff;" onclick="document.getElementById('settingsModal').style.display='none'" data-i18n="btn_close">å…³é—­</button>
    </div>
</div>

<div id="historyPop" class="modal-overlay" onclick="this.style.display='none'"><div class="modal-card" onclick="event.stopPropagation()"><div class="modal-title" data-i18n="modal_history">å†å²è®°å½•</div><div id="historyList" style="max-height:300px; overflow-y:auto;"></div><button class="btn-block" style="background:#333; color:#fff;" onclick="document.getElementById('historyPop').style.display='none'" data-i18n="btn_close">å…³é—­</button></div></div>
<div id="exportModal" class="modal-overlay"><div class="modal-card"><div class="modal-title">Excel CSV Data</div><textarea id="exportText" class="export-text" rows="10" readonly></textarea><button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="copyExportText()" data-i18n="btn_copy">å¤åˆ¶å…¨éƒ¨</button><button class="btn-block" style="background:#444; color:#fff;" onclick="document.getElementById('exportModal').style.display='none'" data-i18n="btn_close">å…³é—­</button></div></div>

<script>
    let logs = [];
    let globalInfo = { container: '', note: '', seller: '', measurer: '', location: '', company: '' };
    let histories = { container: [], seller: [], measurer: [], location: [], company: [] };
    let appSettings = { deductLen: 0, deductDia: 0, showGrade: true, calcDia: false, roundMode: 'up' };
    let nextRoundUp = true; // For mix mode tracking
    const GRADES = ['F', 'A+', 'A', 'B', 'C', 'D'];
    let activeFilter = null;
    let currentLang = 'zh';
    let isQuickMode = false;

    const I18N = {
        zh: { btn_new: "âŸ³ æ–°æŸœ", btn_info: "ğŸ“‹ ä¿¡æ¯", btn_pdf: "PDF", btn_excel: "å¯¼å‡º", container: "é›†è£…ç®±å·", note_global: "æ•´å•å¤‡æ³¨", seller: "å–æ–¹å…¬å¸", measurer: "æµ‹é‡äºº", location: "åœ°ç‚¹", my_company: "å…¬å¸åç§°", code: "ç å·", grade: "ç­‰çº§", len: "é•¿(m)", dia: "å¾„(cm)", vol: "ä½“ç§¯", note: "å¤‡æ³¨", idx: "åº", inputting: "â— æ­£åœ¨è¾“å…¥", add_next: "+ æ·»åŠ å¹¶ä¸‹ä¸€æ ¹", total_count: "æ€»æ•°", total_vol: "æç§¯", modal_info_title: "é¡¹ç›®ä¿¡æ¯", modal_history: "å†å²è®°å½•", btn_close: "å…³é—­", btn_copy: "å¤åˆ¶å†…å®¹", p_date: "æ—¥æœŸ", select_grade: "é€‰æ‹©ç­‰çº§", quick_on: "âš¡ å¿«é€Ÿæ¨¡å¼: å¼€", quick_off: "âš¡ å¿«é€Ÿæ¨¡å¼: å…³", settings_title: "è®¾ç½®", language: "è¯­è¨€ / Language", show_grade: "æ˜¾ç¤ºç­‰çº§æŒ‰é’®", len_deduct: "é•¿åº¦æ‰£å‡", dia_deduct: "ç›´å¾„æ‰£å‡", deduction_desc: "è‡ªåŠ¨æ‰£å‡ (å•ä½: å˜ç±³)", calc_dia: "åŒå¾„æ¨¡å¼ (è®¡ç®—å¹³å‡å€¼)" },
        en: { btn_new: "âŸ³ Reset", btn_info: "ğŸ“‹ Info", btn_pdf: "PDF", btn_excel: "Export", container: "Container", note_global: "Global Note", seller: "Seller", measurer: "Measurer", location: "Location", my_company: "Company", code: "Code", grade: "Grade", len: "L(m)", dia: "D(cm)", vol: "Vol", note: "Note", idx: "#", inputting: "â— Inputting", add_next: "+ Add & Next", total_count: "Count", total_vol: "Volume", modal_info_title: "Project Info", modal_history: "History", btn_close: "Close", btn_copy: "Copy All", p_date: "Date", select_grade: "Select Grade", quick_on: "âš¡ Quick Mode: ON", quick_off: "âš¡ Quick Mode: OFF", settings_title: "Settings", language: "Language", show_grade: "Show Grades", len_deduct: "Len Deduct", dia_deduct: "Dia Deduct", deduction_desc: "Auto Deduction (Unit: cm)", calc_dia: "Dual Dia Mode (Average)" },
        sl: { btn_new: "âŸ³ Nov", btn_info: "ğŸ“‹ Info", btn_pdf: "PDF", btn_excel: "Izvozi", container: "Kontejner", note_global: "Opomba", seller: "Prodajalec", measurer: "Merilec", location: "Lokacija", my_company: "Podjetje", code: "Å t.", grade: "Razred", len: "D(m)", dia: "P(cm)", vol: "Vol", note: "Opomba", idx: "#", inputting: "â— Vnos", add_next: "+ Dodaj", total_count: "KoliÄina", total_vol: "Volumen", modal_info_title: "Podatki", modal_history: "Zgodovina", btn_close: "Zapri", btn_copy: "Kopiraj", p_date: "Datum", select_grade: "Izberi Razred", quick_on: "âš¡ Hitro: ON", quick_off: "âš¡ Hitro: OFF", settings_title: "Nastavitve", language: "Jezik", show_grade: "PrikaÅ¾i Razrede", len_deduct: "Odbitek DolÅ¾ine", dia_deduct: "Odbitek Premera", deduction_desc: "Samodejni odbitek (cm)", calc_dia: "Dvojni premer (PovpreÄje)" }
    };

    const STORAGE_KEY = 'oak_v281_data';
    const HIST_KEY = 'oak_v281_hist';
    const LANG_KEY = 'oak_v281_lang';
    const QUICK_KEY = 'oak_v281_quick';
    const SETTINGS_KEY = 'oak_v281_settings';
    const MIX_STATE_KEY = 'oak_v281_mix';

    window.onload = () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if(savedData) {
            const p = JSON.parse(savedData);
            logs = p.logs || [];
            globalInfo = p.global || globalInfo;
            ['container', 'note', 'seller', 'measurer', 'location', 'company'].forEach(k => {
                const el = document.getElementById('g_'+k);
                if(el) el.value = globalInfo[k] || '';
            });
        }
        const savedHist = localStorage.getItem(HIST_KEY);
        if(savedHist) histories = JSON.parse(savedHist);
        ['container', 'seller', 'measurer', 'location', 'company'].forEach(k => { if(!histories[k]) histories[k] = []; });

        const savedLang = localStorage.getItem(LANG_KEY);
        if(savedLang) { currentLang = savedLang; document.getElementById('langSelect').value = currentLang; }
        
        const savedQuick = localStorage.getItem(QUICK_KEY);
        if(savedQuick === 'true') { isQuickMode = true; }

        const savedSet = localStorage.getItem(SETTINGS_KEY);
        if(savedSet) { appSettings = Object.assign(appSettings, JSON.parse(savedSet)); }
        
        const savedMix = localStorage.getItem(MIX_STATE_KEY);
        if(savedMix) { nextRoundUp = (savedMix === 'true'); }

        document.getElementById('setDeductLen').value = appSettings.deductLen || 0;
        document.getElementById('setDeductDia').value = appSettings.deductDia || 0;
        document.getElementById('checkShowGrade').checked = appSettings.showGrade;
        document.getElementById('checkCalcDia').checked = appSettings.calcDia || false;
        document.getElementById('roundSelect').value = appSettings.roundMode || 'up';

        applyLanguage();
        updateQuickBtnUI();
        toggleCalcDia(); 
        if(logs.length === 0) addNewLog();
        renderAll();
    };

    function changeLanguage(lang) { currentLang = lang; localStorage.setItem(LANG_KEY, lang); applyLanguage(); renderAll(); updateQuickBtnUI(); }
    function applyLanguage() {
        const texts = I18N[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(texts[key]) el.innerText = texts[key]; });
    }
    function updateGlobal() { ['container', 'note', 'seller', 'measurer', 'location', 'company'].forEach(k => { globalInfo[k] = document.getElementById('g_'+k).value; }); save(); }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ logs, global: globalInfo })); updateStats(); }
    function saveSettings() {
        appSettings.deductLen = parseFloat(document.getElementById('setDeductLen').value) || 0;
        appSettings.deductDia = parseFloat(document.getElementById('setDeductDia').value) || 0;
        appSettings.roundMode = document.getElementById('roundSelect').value;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
    }
    function toggleGradeDisplay() {
        appSettings.showGrade = document.getElementById('checkShowGrade').checked;
        saveSettings();
        renderAll();
    }
    function toggleCalcDia() {
        appSettings.calcDia = document.getElementById('checkCalcDia').checked;
        document.getElementById('roundModeRow').style.display = appSettings.calcDia ? 'flex' : 'none';
        saveSettings();
        renderAll();
    }
    
    function openSettingsModal() { document.getElementById('settingsModal').style.display='flex'; }
    function cleanInput(val) { if(!val) return ''; return val.replace(/,/g, '.').replace(/[^0-9.]/g, ''); }
    function autoFixInput(input) {
        let val = input.value;
        if(val.includes(',')) {
            input.value = val.replace(/,/g, '.');
            const id = input.getAttribute('data-id');
            const field = input.getAttribute('data-field');
            if(id && field) updateItem(parseInt(id), field, input.value);
        }
    }

    function toggleQuickMode() { isQuickMode = !isQuickMode; localStorage.setItem(QUICK_KEY, isQuickMode); updateQuickBtnUI(); }
    function updateQuickBtnUI() {
        const btn = document.getElementById('quickModeBtn');
        const t = I18N[currentLang];
        if(isQuickMode) { btn.classList.add('active'); btn.innerText = t.quick_on; }
        else { btn.classList.remove('active'); btn.innerText = t.quick_off; }
    }
    
    function handleQuickLength(input) {
        if (!isQuickMode) return;
        let val = input.value;
        if (!val) return;
        if (val.startsWith('1')) return;

        if (/^\d+$/.test(val)) {
            let num = parseInt(val);
            let newVal = null;
            if (num >= 20 && num <= 99) newVal = (num / 10).toString();
            else if (num >= 101 && num <= 159) newVal = (num / 10).toString();
            if (newVal) {
                input.value = newVal;
                if(logs.length > 0) logs[0].length = newVal;
                updateItem(logs[0].id, 'length', newVal);

                if (appSettings.calcDia) {
                    document.getElementById('in-dia-1').focus();
                } else {
                    const diaInput = document.querySelector(`.log-card .field input[data-field="diameter"]`);
                    if(diaInput) diaInput.focus();
                }
            }
        }
    }

    // å•å¾„æ¨¡å¼
    function handleQuickDiameterSingle(input) {
        if (!isQuickMode) return;
        // å¦‚æœç­‰çº§å¼€å¯ï¼Œç”±ç­‰çº§ç‚¹å‡»è§¦å‘ï¼›å¦‚æœå…³é—­ï¼Œç”±è¾“å…¥è§¦å‘
        if (appSettings.showGrade) return;

        const val = input.value;
        if (!val) return;
        
        // 1å¼€å¤´ç­‰å¾…3ä½
        if (val.length === 2 && /^\d+$/.test(val) && !val.startsWith('1')) { saveAndJumpSingle(val); }
        if (val.length === 3 && /^\d+$/.test(val)) { saveAndJumpSingle(val); }
    }
    function saveAndJumpSingle(val) {
        updateItem(logs[0].id, 'diameter', val);
        setTimeout(() => { 
            addNewLog();
            setTimeout(() => {
                const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                if(lenInput) lenInput.focus(); 
            }, 0); // Immediate jump
        }, 150);
    }

    // åŒå¾„ - ç›´å¾„1
    function handleQuickDia1(input) {
        if (!isQuickMode) return;
        const val = input.value;
        if (!val) return;
        if (val.length === 2 && /^\d+$/.test(val)) {
             if (!val.startsWith('1')) {
                 document.getElementById('in-dia-2').focus();
             }
        }
        if (val.length === 3 && /^\d+$/.test(val)) {
            document.getElementById('in-dia-2').focus();
        }
    }

    // åŒå¾„ - ç›´å¾„2
    function handleQuickDia2(input) {
        if (!isQuickMode) return;
        const val = input.value;
        if (!val) return;
        
        let isDone = false;
        if (val.length === 2 && /^\d+$/.test(val) && !val.startsWith('1')) isDone = true;
        if (val.length === 3 && /^\d+$/.test(val)) isDone = true;

        if (isDone) {
            // å¦‚æœç­‰çº§å¼€å…³å¼€å¯ -> åœä½
            if (appSettings.showGrade) return;
            
            // å¦‚æœç­‰çº§å…³é—­ -> è‡ªåŠ¨ä¿å­˜å¹¶è·³åˆ°ä¸‹ä¸€è¡Œé•¿åº¦
            setTimeout(() => { 
                addNewLog();
                setTimeout(() => {
                    const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                    if(lenInput) lenInput.focus(); 
                }, 0);
            }, 150);
        }
    }

    function calculateDualDia(d1, d2) {
        const avg = (d1 + d2) / 2;
        if (avg % 1 === 0.5) {
            if (appSettings.roundMode === 'up') return Math.ceil(avg);
            if (appSettings.roundMode === 'down') return Math.floor(avg);
            if (appSettings.roundMode === 'mix') {
                const res = nextRoundUp ? Math.ceil(avg) : Math.floor(avg);
                nextRoundUp = !nextRoundUp;
                localStorage.setItem(MIX_STATE_KEY, nextRoundUp);
                return res;
            }
        }
        return Math.round(avg);
    }

    function getNextCode() {
        if(logs.length === 0) return '';
        const match = logs[0].code.match(/^(.*?)(\d+)$/);
        return match ? match[1] + (parseInt(match[2]) + 1).toString().padStart(match[2].length, '0') : logs[0].code;
    }

    function addNewLog() {
        if(logs.length > 0) {
            const current = logs[0];
            
            if(appSettings.calcDia) {
                const d1 = parseFloat(document.getElementById('in-dia-1').value) || 0;
                const d2 = parseFloat(document.getElementById('in-dia-2').value) || 0;
                if(d1 > 0 && d2 > 0) {
                    const finalDia = calculateDualDia(d1, d2);
                    current.diameter = finalDia.toString();
                } else if (d1 > 0) {
                    current.diameter = d1.toString();
                }
            }

            let rawLen = parseFloat(cleanInput(current.length.toString()));
            let rawDia = parseFloat(cleanInput(current.diameter.toString()));
            let changed = false;

            if(rawLen > 0 && appSettings.deductLen > 0) {
                rawLen = rawLen - (appSettings.deductLen / 100);
                if(rawLen < 0) rawLen = 0;
                current.length = parseFloat(rawLen.toFixed(2)).toString();
                changed = true;
            }
            if(rawDia > 0 && appSettings.deductDia > 0) {
                rawDia = rawDia - appSettings.deductDia;
                if(rawDia < 0) rawDia = 0;
                current.diameter = rawDia.toString(); 
                changed = true;
            }

            if(changed || appSettings.calcDia) {
                const radius_m = rawDia / 200;
                current.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * rawLen).toFixed(3));
            }
        }

        document.querySelectorAll('input').forEach(i => autoFixInput(i));
        const newLog = { id: Date.now(), code: getNextCode(), grade: '', length: '', diameter: '', volume: 0, note: '' };
        logs.unshift(newLog);
        save();
        renderAll();
        activeFilter = null;
        applyFilter();
        
        // Focus Length Input (Keep keyboard up)
        setTimeout(() => {
            const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
            if(lenInput) { lenInput.focus(); lenInput.click(); }
        }, 10);
    }

    function renderAll() {
        const container = document.getElementById('logList');
        container.innerHTML = '';
        const t = I18N[currentLang];
        if(logs.length > 1) {
            const header = document.createElement('div');
            header.className = 'list-header';
            header.innerHTML = `<div>${t.idx}</div><div>${t.code}</div><div>${t.grade}</div><div>${t.len}</div><div>${t.dia}</div><div>${t.vol}</div><div>${t.note}</div><div></div>`;
            container.appendChild(header);
        }
        logs.forEach((log, index) => {
            const realIndex = logs.length - index;
            if(index === 0) container.insertBefore(createCard(log, realIndex), container.firstChild);
            else container.appendChild(createRow(log, realIndex));
        });
        updateStats();
        applyFilter();
    }

    function createCard(log, idx) {
        const t = I18N[currentLang];
        let btnsHtml = '';
        GRADES.forEach(g => {
            const isActive = log.grade === g ? 'active' : '';
            btnsHtml += `<button class="btn-grade ${isActive}" onmousedown="event.preventDefault()" onclick="setGrade(${log.id}, '${g}')">${g}</button>`;
        });

        const gradeDisplayClass = appSettings.showGrade ? '' : 'hidden';

        let diaInputHtml = '';
        if (appSettings.calcDia) {
            // åŒå¾„æ¨¡å¼ - ä½¿ç”¨æ ‡å‡†çš„ text+decimal æ¨¡å¼ï¼Œç¡®ä¿æ•°å­—é”®ç›˜
            diaInputHtml = `
                <div class="double-input-container">
                    <input type="text" inputmode="decimal" id="in-dia-1" oninput="handleQuickDia1(this)">
                    <input type="text" inputmode="decimal" id="in-dia-2" oninput="handleQuickDia2(this)">
                </div>
            `;
        } else {
            diaInputHtml = `
                <input type="text" inputmode="decimal" value="${log.diameter}" data-id="${log.id}" data-field="diameter" oninput="updateItem(${log.id},'diameter',this.value); handleQuickDiameterSingle(this)" onblur="autoFixInput(this)">
            `;
        }

        const div = document.createElement('div');
        div.className = 'log-card';
        div.innerHTML = `
            <div class="card-title"><span>${t.inputting}</span><span>NO. ${idx}</span></div>
            <div class="card-row-1">
                <div class="field"><label>${t.code}</label><input type="text" inputmode="numeric" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)"></div>
                <div class="field"><label>${t.note}</label><input type="text" class="input-note" value="${log.note || ''}" oninput="updateItem(${log.id},'note',this.value)"></div>
            </div>
            <div class="card-row-2">
                <div class="field"><label>${t.len}</label>
                    <input type="text" inputmode="decimal" value="${log.length}" data-id="${log.id}" data-field="length" oninput="updateItem(${log.id},'length',this.value); handleQuickLength(this)" onblur="autoFixInput(this)">
                </div>
                <div class="field"><label>${t.dia}</label>
                    ${diaInputHtml}
                </div>
                <div class="live-vol-display" id="v-${log.id}">${log.volume.toFixed(3)}</div>
            </div>
            
            <div class="grade-section ${gradeDisplayClass}">
                <div class="grade-label">${t.select_grade}</div>
                <div class="grade-container">${btnsHtml}</div>
            </div>
            
            <button class="btn-add-inline" onclick="addNewLog()">${t.add_next}</button>
        `;
        return div;
    }

    function createRow(log, idx) {
        let gradeOptions = `<option value="">-</option>`;
        gradeOptions += GRADES.map(g => `<option value="${g}" ${log.grade===g?'selected':''}>${g}</option>`).join('');

        const div = document.createElement('div');
        div.className = 'log-row';
        div.id = 'row-' + log.id;
        div.setAttribute('data-grade', log.grade || '?');
        const len_m = parseFloat(cleanInput(log.length.toString()));
        const d_cm = parseFloat(cleanInput(log.diameter.toString()));
        div.setAttribute('data-len', len_m || 0);
        div.setAttribute('data-dia', d_cm || 0);
        const warnClass = (len_m > 15) ? 'danger-text' : '';

        const displayLen = log.length ? parseFloat(log.length) : '';
        const displayDia = log.diameter ? parseFloat(log.diameter) : '';

        div.innerHTML = `
            <div class="row-index">${idx}</div>
            <input type="text" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)">
            <select onchange="updateItem(${log.id},'grade',this.value)">${gradeOptions}</select>
            <input type="text" id="inp-len-${log.id}" class="${warnClass}" inputmode="decimal" value="${displayLen}" oninput="updateItem(${log.id},'length',this.value)" onblur="autoFixInput(this)">
            <input type="text" inputmode="decimal" value="${displayDia}" oninput="updateItem(${log.id},'diameter',this.value)" onblur="autoFixInput(this)">
            <div class="col-vol" id="v-row-${log.id}">${log.volume.toFixed(3)}</div>
            <input type="text" style="font-size:12px;color:#aaa;text-align:left;" value="${log.note||''}" oninput="updateItem(${log.id},'note',this.value)">
            <button class="btn-del-mini" onclick="delItem(${log.id})">Ã—</button>
        `;
        return div;
    }

    function setGrade(id, grade) {
        updateItem(id, 'grade', grade);
        if (isQuickMode) { 
            addNewLog();
            setTimeout(() => {
                const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                if(lenInput) lenInput.focus(); 
            }, 0);
        } 
        else { renderAll(); }
    }

    function updateItem(id, field, val) {
        const item = logs.find(l => l.id === id);
        item[field] = val;
        
        if(field === 'length' || field === 'diameter') {
            let l_str = item.length.toString().replace(/,/g, '.');
            let d_str = item.diameter.toString().replace(/,/g, '.');
            const l = parseFloat(l_str);
            const d = parseFloat(d_str);
            if (!isNaN(l) && !isNaN(d) && l > 0 && d > 0) {
                const radius_m = d / 200;
                item.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * l).toFixed(3));
            } else { item.volume = 0; }
            const vDisplay = document.getElementById('v-'+id); if(vDisplay) vDisplay.innerText = item.volume.toFixed(3);
            const vRowDisplay = document.getElementById('v-row-'+id); if(vRowDisplay) vRowDisplay.innerText = item.volume.toFixed(3);
            if(field === 'length') {
                const rowLenInput = document.getElementById('inp-len-' + id);
                if(rowLenInput) {
                    if(l > 15) rowLenInput.classList.add('danger-text');
                    else rowLenInput.classList.remove('danger-text');
                }
            }
        }
        
        // å®æ—¶åŒå¾„é¢„è§ˆ
        if(appSettings.calcDia && id === logs[0].id) {
             const d1 = parseFloat(document.getElementById('in-dia-1').value) || 0;
             const d2 = parseFloat(document.getElementById('in-dia-2').value) || 0;
             if(d1 > 0 && d2 > 0) {
                 const avg = (d1 + d2) / 2;
                 const l = parseFloat(item.length) || 0;
                 if(l > 0) {
                     const r = avg / 200;
                     const v = (Math.PI * Math.pow(r, 2) * l).toFixed(3);
                     document.getElementById('v-'+id).innerText = v;
                 }
             }
        }

        save();
        if(activeFilter) applyFilter();
    }

    function delItem(id) { if(confirm('Delete?')) { logs = logs.filter(l => l.id !== id); renderAll(); save(); } }

    function resetLogOnly() {
        if(confirm(I18N[currentLang].btn_new + '?')) {
            logs = [];
            globalInfo.container = '';
            document.getElementById('g_container').value = '';
            save();
            location.reload();
        }
    }

    function updateStats() {
        const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
        const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
        document.getElementById('totalCount').innerText = validLogs.length;
        document.getElementById('totalVol').innerText = totalV.toFixed(3);

        const gStats = {};
        let l4 = 0, l25 = 0, d30 = 0;
        validLogs.forEach(l => {
            const g = l.grade || '?';
            gStats[g] = (gStats[g] || 0) + 1;
            const len_m = parseFloat(cleanInput(l.length.toString()));
            const d_cm = parseFloat(cleanInput(l.diameter.toString()));
            if(len_m < 4.0) l4++;
            if(len_m < 2.5) l25++;
            if(d_cm < 30) d30++;
        });

        let html = '';
        const mkTag = (key, label, count) => {
            if(count === 0) return '';
            const isActive = activeFilter === key ? 'active-filter' : '';
            return `<div class="stat-tag ${isActive}" onclick="toggleFilter('${key}')">${label}: <b>${count}</b></div>`;
        };
        for(let g in gStats) if(g!=='?' && g!=='') html += mkTag('g_'+g, g, gStats[g]);
        html += mkTag('l4', '< 4m', l4);
        html += mkTag('l25', '< 2.5m', l25);
        html += mkTag('d30', '< 30cm', d30);
        document.getElementById('statsDetail').innerHTML = html;

        let summaryHtml = `<h3>${currentLang==='zh'?'ç»Ÿè®¡æ±‡æ€»':(currentLang==='en'?'Summary':'Povzetek')}</h3>
        <p>${I18N[currentLang].total_count}: ${validLogs.length} &nbsp; ${I18N[currentLang].total_vol}: ${totalV.toFixed(3)} mÂ³</p>
        <p>Grade: <br>`;
        for(let g in gStats) if(g!=='?' && g!=='') summaryHtml += `<span style="margin-right:20px; display:inline-block;">${g}: <b>${gStats[g]}</b></span>`;
        summaryHtml += `</p>`;
        document.getElementById('printSummary').innerHTML = summaryHtml;
    }

    function toggleFilter(key) {
        if(activeFilter === key) activeFilter = null;
        else activeFilter = key;
        updateStats();
        applyFilter();
    }

    function applyFilter() {
        const rows = document.querySelectorAll('.log-row');
        if(!activeFilter) {
            rows.forEach(r => { r.classList.remove('dimmed', 'highlighted'); });
            return;
        }
        rows.forEach(r => {
            let match = false;
            const g = r.getAttribute('data-grade');
            const l = parseFloat(r.getAttribute('data-len'));
            const d = parseFloat(r.getAttribute('data-dia'));
            if(activeFilter.startsWith('g_') && activeFilter === 'g_' + g) match = true;
            else if(activeFilter === 'l4' && l < 4.0) match = true;
            else if(activeFilter === 'l25' && l < 2.5) match = true;
            else if(activeFilter === 'd30' && d < 30) match = true;
            if(match) { r.classList.add('highlighted'); r.classList.remove('dimmed'); }
            else { r.classList.add('dimmed'); r.classList.remove('highlighted'); }
        });
    }

    function openInfoModal() { document.getElementById('infoModal').style.display = 'flex'; }
    function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; updateGlobal(); }

    function togglePrintMode() {
        const body = document.body;
        if (body.classList.contains('print-mode')) {
            body.classList.remove('print-mode');
        } else {
            const d = new Date();
            const dateStr = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
            document.getElementById('p_company').innerText = globalInfo.company;
            document.getElementById('print_row_company').style.display = globalInfo.company ? 'table-row' : 'none';
            document.getElementById('p_date').innerText = dateStr;
            document.getElementById('p_container').innerText = globalInfo.container;
            document.getElementById('p_seller').innerText = globalInfo.seller;
            document.getElementById('p_location').innerText = globalInfo.location;
            document.getElementById('print_row_seller').style.display = (!globalInfo.seller && !globalInfo.location) ? 'none' : 'table-row';
            document.getElementById('p_measurer').innerText = globalInfo.measurer;
            document.getElementById('print_row_measurer').style.display = globalInfo.measurer ? 'table-row' : 'none';
            document.getElementById('p_note').innerText = globalInfo.note;
            document.getElementById('print_row_note').style.display = (!globalInfo.note) ? 'none' : 'table-row';
            body.classList.add('print-mode');
            setTimeout(() => { try { window.print(); } catch(e){} }, 300);
        }
    }

    async function exportData() {
        const d = new Date();
        const timeStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}-${d.getMinutes()}`;
        const ds = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
        const t = I18N[currentLang];
        let header = `\ufeff${t.p_date},${ds}\n`;
        if(globalInfo.company) header += `${t.my_company},${globalInfo.company}\n`;
        if(globalInfo.container) header += `${t.container},${globalInfo.container}\n`;
        if(globalInfo.note) header += `${t.note_global},${globalInfo.note}\n`;
        if(globalInfo.seller) header += `${t.seller},${globalInfo.seller}\n`;
        if(globalInfo.measurer) header += `${t.measurer},${globalInfo.measurer}\n`;
        if(globalInfo.location) header += `${t.location},${globalInfo.location}\n`;
        let csv = header + `\n${t.idx},${t.code},${t.grade},${t.len},${t.dia},${t.vol},${t.note}\n`;
        const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
        [...validLogs].reverse().forEach((l, idx) => {
            let len = l.length.toString().replace(/,/g, '.');
            let dia = l.diameter.toString().replace(/,/g, '.');
            csv += `${idx+1},${l.code},${l.grade},${len},${dia},${l.volume.toFixed(3)},${l.note||''}\n`;
        });
        const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
        let l4 = 0, l25 = 0, d30 = 0;
        validLogs.forEach(l => {
            const len_m = parseFloat(l.length.toString().replace(/,/g, '.'));
            const dia_cm = parseFloat(l.diameter.toString().replace(/,/g, '.'));
            if(len_m < 4.0) l4++; if(len_m < 2.5) l25++; if(dia_cm < 30) d30++;
        });
        csv += `\n\n=== ${currentLang==='zh'?'ç»Ÿè®¡':'Summary'} ===\n`;
        csv += `${t.total_count},${validLogs.length}\n${t.total_vol},${totalV.toFixed(3)}\n`;
        csv += `\n< 4m,${l4}\n< 2.5m,${l25}\n< 30cm,${d30}\n\n`;
        const gStats = {}; validLogs.forEach(l => { gStats[l.grade] = (gStats[l.grade] || 0) + 1; });
        for(let g in gStats) if(g!=='?' && g!=='') csv += `${g},${gStats[g]}\n`;
        const fileName = `Oak_${timeStr}.csv`;
        if (navigator.share) {
            try { await navigator.share({ files: [new File([csv], fileName, {type: 'text/csv'})], title: 'Export' }); return; } catch (e) {}
        }
        document.getElementById('exportText').value = csv;
        document.getElementById('exportModal').style.display = 'flex';
    }
    function copyExportText() { document.getElementById('exportText').select(); document.execCommand('copy'); alert('Copied'); document.getElementById('exportModal').style.display='none'; }

    function saveToHistory(t){const v=document.getElementById('g_'+t).value.trim();if(v&&!histories[t].includes(v)){histories[t].push(v);localStorage.setItem(HIST_KEY,JSON.stringify(histories));alert('Saved');}}
    function showHistory(t){
        const l=document.getElementById('historyList');l.innerHTML='';
        const items = histories[t] || [];
        if(items.length===0) l.innerHTML='<div style="padding:10px;color:#666;">No Record</div>';
        items.forEach((i,x)=>{
            const d=document.createElement('div');
            d.style.cssText='padding:12px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;';
            d.innerHTML=`<div onclick="selectHistory('${t}','${i}')" style="flex:1;color:#fff;">${i}</div><div onclick="delHistory('${t}',${x})" style="color:red;padding:5px 10px;font-size:18px;">Ã—</div>`;
            l.appendChild(d);
        });
        document.getElementById('historyPop').style.display='flex';
    }
    function selectHistory(t,v){document.getElementById('g_'+t).value=v;globalInfo[t]=v;document.getElementById('historyPop').style.display='none';save();}
    function delHistory(t,i){histories[t].splice(i,1);localStorage.setItem(HIST_KEY,JSON.stringify(histories));showHistory(t);}
</script>
</body>
</html>
