<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oak Master V26.0</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --accent-color: #d4a373; 
            --highlight-border: #ffd700;
            --input-bg: #2a2a2a;
            --border-color: #333;
            --danger-color: #ff5252;
            --active-mode: #4caf50;
        }

        /* --- ÊâìÂç∞/È¢ÑËßàÊ®°Âºè --- */
        @media print {
            .btn-exit-print { display: none !important; }
            @page { margin: 0; size: auto; }
            body.print-mode { padding: 1.5cm !important; margin: 0 !important; }
            .header, .global-section, .log-card, .footer, .btn-del-mini, .modal-overlay { display: none !important; }
        }

        body.print-mode { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
        body.print-mode .header, body.print-mode .global-section, body.print-mode .log-card, 
        body.print-mode .footer, body.print-mode .btn-del-mini, body.print-mode .btn-add-inline { display: none !important; }
        
        body.print-mode .btn-exit-print { display: block !important; width: 100%; background: #333; color: #fff; padding: 15px; margin-bottom: 20px; border: none; border-radius: 8px; font-size: 16px; }
        .btn-exit-print { display: none; }

        .print-header-table { display: none; width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
        body.print-mode .print-header-table { display: table !important; }
        .print-header-table td { border: 1px solid #000; padding: 5px; color: #000; }

        body.print-mode .list-header { 
            background: #eee !important; color: black !important; border: 1px solid #000; position: static !important;
            grid-template-columns: 0.5fr 2fr 0.8fr 0.8fr 0.8fr 1.2fr 2fr !important;
        }
        body.print-mode .log-row { 
            background: transparent !important; color: black !important; border: 1px solid #000; border-top: none;
            grid-template-columns: 0.5fr 2fr 0.8fr 0.8fr 0.8fr 1.2fr 2fr !important; opacity: 1 !important;
        }
        body.print-mode input, body.print-mode select { 
            color: black !important; background: transparent !important; border: none !important; 
            text-align: center; width: 100%; font-weight: normal; appearance: none;
        }
        body.print-mode .col-vol { color: black !important; }
        .print-summary-box { display: none; margin-top: 20px; border: 2px solid #000; padding: 10px; }
        body.print-mode .print-summary-box { display: block !important; }

        /* --- Ê≠£Â∏∏Ê®°Âºè --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; padding-bottom: 120px; background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, sans-serif; font-size: 14px; transition: all 0.3s; }

        .header { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .btn-header { padding: 6px 10px; border-radius: 4px; border: none; font-weight: bold; font-size: 11px; cursor: pointer; }
        .btn-info { background: #444; color: #fff; display: flex; align-items: center; gap: 4px; border: 1px solid #555; }
        .btn-export { background: var(--accent-color); color: #000; margin-left: 5px; }
        .btn-pdf { background: #555; color: #fff; margin-left: 5px; }
        .btn-reset { background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); }

        .global-section { margin-top: 60px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-box { display: flex; flex-direction: column; }
        .input-box label { font-size: 11px; color: #888; margin-bottom: 2px; }
        input, select { background: var(--input-bg); border: 1px solid var(--border-color); color: #fff; height: 38px; border-radius: 4px; padding: 0 8px; font-size: 14px; width: 100%; }

        .list-header { display: grid; grid-template-columns: 0.5fr 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; padding: 10px; background: #252525; margin-top: 10px; font-size: 11px; color: #888; position: sticky; top: 50px; z-index: 90; }

        .log-card { background: var(--card-bg); margin: 10px; border-radius: 8px; padding: 15px; border: 2px solid var(--accent-color); box-shadow: 0 4px 15px rgba(212,163,115,0.2); }
        .card-title { font-size: 10px; color: var(--accent-color); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; }
        .card-row-1 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .card-row-2 { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 10px; margin-bottom: 15px; align-items: end; }
        .field { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .field label { font-size: 11px; color: #888; }
        .field input { height: 44px; font-size: 18px; border-color: var(--accent-color); font-weight: bold; }
        .input-note { font-size: 14px !important; font-weight: normal !important; color: #bbb !important; }
        .live-vol-display { height: 44px; background: rgba(0,0,0,0.3); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--accent-color); font-size: 20px; font-weight: bold; font-family: monospace; border: 1px solid #333; }
        
        .grade-label { font-size: 11px; color: #888; margin-bottom: 5px; }
        .grade-container { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 15px; }
        .btn-grade { flex: 1; height: 40px; background: #333; border: 1px solid #444; color: #888; border-radius: 6px; font-weight: bold; font-size: 14px; padding: 0; cursor: pointer; }
        .btn-grade:active { transform: scale(0.95); }
        .btn-grade.active { background: var(--accent-color); color: var(--active-text); border-color: var(--accent-color); box-shadow: 0 0 8px rgba(212,163,115,0.4); }
        
        .btn-add-inline { width: 100%; height: 50px; background: var(--accent-color); color: #000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .btn-add-inline:active { transform: scale(0.98); }

        .log-row { display: grid; grid-template-columns: 0.5fr 2fr 0.8fr 1fr 1fr 1.5fr 1.5fr 0.8fr; gap: 4px; padding: 6px 10px; background: var(--card-bg); border-bottom: 1px solid #2a2a2a; align-items: center; transition: opacity 0.3s; }
        .log-row.dimmed { opacity: 0.2; } 
        .log-row.highlighted { border: 1px solid var(--highlight-border); background-color: #333; }
        .log-row input { height: 34px; font-size: 13px; border: none; background: transparent; text-align: center; }
        .log-row select { height: 34px; font-size: 13px; border: none; background: transparent; text-align: center; color: #fff; font-weight: bold; appearance: none; -webkit-appearance: none; }
        .row-index { color: #666; font-size: 12px; text-align: center; }
        .log-row input:nth-child(2), .log-row input:nth-child(7) { text-align: left; }
        .col-vol { color: var(--accent-color); font-weight: bold; font-family: monospace; text-align: center; font-size: 12px; }
        .btn-del-mini { color: var(--danger-color); background: none; border: none; font-size: 18px; }
        
        .danger-text { color: var(--danger-color) !important; font-weight: bold; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); z-index: 110; }
        .stats-detail { display: flex; overflow-x: auto; padding: 8px; gap: 8px; font-size: 11px; border-bottom: 1px solid #222; }
        .stat-tag { background: #2a2a2a; padding: 4px 10px; border-radius: 12px; white-space: nowrap; cursor: pointer; border: 1px solid transparent; user-select: none; }
        .stat-tag.active-filter { border-color: var(--accent-color); background: #444; color: #fff; }
        .stats-main { display: flex; justify-content: space-around; padding: 15px 10px; font-weight: bold; align-items: baseline; }
        .stats-main span { font-size: 14px; color: #aaa; }
        .stats-main span strong { font-size: 24px; color: var(--accent-color); margin-left: 5px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; padding: 20px; flex-direction: column; justify-content: center; }
        .modal-card { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .info-row { margin-bottom: 15px; }
        .info-row label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        .info-controls { display: flex; gap: 5px; }
        .btn-tool { background: #333; border: 1px solid #444; color: #ccc; width: 40px; height: 38px; border-radius: 4px; border: none; flex-shrink: 0; }
        .export-text { flex: 1; background: #111; color: #fff; border: 1px solid #444; padding: 10px; font-size: 12px; margin-bottom: 10px; }
        .btn-block { width: 100%; height: 45px; border-radius: 6px; border: none; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        
        .toggle-btn { background: #333; color: #aaa; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px; display: flex; align-items: center; gap: 5px; }
        .toggle-btn.active { background: var(--active-mode); color: white; border-color: var(--active-mode); }
    </style>
</head>
<body>

    <button class="btn-exit-print" onclick="togglePrintMode()">‚¨Ö <span data-i18n="back_edit">ËøîÂõûÁºñËæëÊ®°Âºè</span></button>

    <table class="print-header-table">
        <tr id="print_row_company"><td colspan="4"><span data-i18n="my_company">ÂÖ¨Âè∏</span>: <span id="p_company" style="font-weight:bold;"></span></td></tr>
        <tr><td width="15%"><span data-i18n="p_date">Êó•Êúü</span>:</td><td width="35%" id="p_date"></td><td width="15%"><span data-i18n="container">ÈõÜË£ÖÁÆ±</span>:</td><td width="35%" id="p_container"></td></tr>
        <tr id="print_row_seller"><td><span data-i18n="seller">ÂçñÊñπ</span>:</td><td id="p_seller"></td><td><span data-i18n="location">Âú∞ÁÇπ</span>:</td><td id="p_location"></td></tr>
        <tr id="print_row_measurer"><td><span data-i18n="measurer">ÊµãÈáè‰∫∫</span>:</td><td id="p_measurer" colspan="3"></td></tr>
        <tr id="print_row_note"><td><span data-i18n="note_global">Â§áÊ≥®</span>:</td><td id="p_note" colspan="3"></td></tr>
    </table>

    <header class="header">
        <div style="display: flex; gap: 10px;">
            <button class="btn-header btn-reset" onclick="resetLogOnly()" data-i18n="btn_new">‚ü≥ Êñ∞Êüú</button>
            <button class="btn-header btn-info" onclick="openInfoModal()" data-i18n="btn_info">üìã ‰ø°ÊÅØ</button>
        </div>
        <div style="display: flex;">
            <button class="btn-header btn-pdf" onclick="togglePrintMode()" data-i18n="btn_pdf">PDF</button>
            <button class="btn-header btn-export" onclick="exportData()" data-i18n="btn_excel">EXCEL</button>
        </div>
    </header>

    <div class="global-section">
        <div class="input-box"><label data-i18n="container">ÈõÜË£ÖÁÆ±Âè∑</label><input type="text" id="g_container" oninput="updateGlobal()"></div>
        <div class="input-box"><label data-i18n="note_global">Êï¥ÂçïÂ§áÊ≥®</label><input type="text" id="g_note" oninput="updateGlobal()"></div>
    </div>

    <div id="logList"></div>
    <div class="print-summary-box" id="printSummary"></div>

    <div class="footer">
        <div class="stats-detail" id="statsDetail"></div>
        <div class="stats-main">
            <span><span data-i18n="total_count">ÊÄªÊï∞</span>:<strong id="totalCount">0</strong></span>
            <span><span data-i18n="total_vol">ÊùêÁßØ</span>:<strong id="totalVol">0.000</strong> m¬≥</span>
        </div>
    </div>

    <div id="infoModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title">
                <div style="display:flex; align-items:center;">
                    <span data-i18n="modal_info_title">È°πÁõÆ‰ø°ÊÅØ</span>
                    <button id="quickModeBtn" class="toggle-btn" onclick="toggleQuickMode()">‚ö°</button>
                </div>
                <select id="langSelect" onchange="changeLanguage(this.value)" style="width:80px; height:30px; font-size:12px;">
                    <option value="zh">‰∏≠Êñá</option>
                    <option value="en">EN</option>
                    <option value="sl">Slo</option>
                </select>
            </div>
            <div class="info-row"><label data-i18n="my_company">ÂÖ¨Âè∏</label><div class="info-controls"><input type="text" id="g_company" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('company')">üíæ</button><button class="btn-tool" onclick="showHistory('company')">üìñ</button></div></div>
            <div class="info-row"><label data-i18n="seller">ÂçñÊñπÂÖ¨Âè∏</label><div class="info-controls"><input type="text" id="g_seller" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('seller')">üíæ</button><button class="btn-tool" onclick="showHistory('seller')">üìñ</button></div></div>
            <div class="info-row"><label data-i18n="measurer">ÊµãÈáè‰∫∫</label><div class="info-controls"><input type="text" id="g_measurer" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('measurer')">üíæ</button><button class="btn-tool" onclick="showHistory('measurer')">üìñ</button></div></div>
            <div class="info-row"><label data-i18n="location">Âú∞ÁÇπ</label><div class="info-controls"><input type="text" id="g_location" oninput="updateGlobal()"><button class="btn-tool" onclick="saveToHistory('location')">üíæ</button><button class="btn-tool" onclick="showHistory('location')">üìñ</button></div></div>
            <button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="closeInfoModal()" data-i18n="btn_close">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="historyPop" class="modal-overlay" onclick="this.style.display='none'"><div class="modal-card" onclick="event.stopPropagation()"><div class="modal-title" data-i18n="modal_history">ÂéÜÂè≤ËÆ∞ÂΩï</div><div id="historyList" style="max-height:300px; overflow-y:auto;"></div><button class="btn-block" style="background:#333; color:#fff;" onclick="document.getElementById('historyPop').style.display='none'" data-i18n="btn_close">ÂÖ≥Èó≠</button></div></div>
    <div id="exportModal" class="modal-overlay"><div class="modal-card"><div class="modal-title">Excel Data</div><textarea id="exportText" class="export-text" rows="10"></textarea><button class="btn-block" style="background:var(--accent-color); color:#000;" onclick="copyExportText()" data-i18n="btn_copy">Â§çÂà∂ÂÖ®ÈÉ®</button><button class="btn-block" style="background:#444; color:#fff;" onclick="document.getElementById('exportModal').style.display='none'" data-i18n="btn_close">ÂÖ≥Èó≠</button></div></div>

    <script>
        let logs = [];
        let globalInfo = { container: '', note: '', seller: '', measurer: '', location: '', company: '' };
        let histories = { seller: [], measurer: [], location: [], company: [] };
        const GRADES = ['F', 'A+', 'A', 'B', 'C', 'D'];
        let activeFilter = null;
        let currentLang = 'zh';
        let isQuickMode = false;

        const I18N = {
            zh: { btn_new: "‚ü≥ Êñ∞Êüú", btn_info: "üìã ‰ø°ÊÅØ", btn_pdf: "PDF", btn_excel: "ÂØºÂá∫", container: "ÈõÜË£ÖÁÆ±Âè∑", note_global: "Êï¥ÂçïÂ§áÊ≥®", seller: "ÂçñÊñπÂÖ¨Âè∏", measurer: "ÊµãÈáè‰∫∫", location: "Âú∞ÁÇπ", my_company: "ÂÖ¨Âè∏", code: "Á†ÅÂè∑", grade: "Á≠âÁ∫ß", len: "Èïø(m)", dia: "ÂæÑ(cm)", vol: "‰ΩìÁßØ", note: "Â§áÊ≥®", idx: "Â∫èÂè∑", inputting: "‚óè Ê≠£Âú®ËæìÂÖ•", add_next: "+ Ê∑ªÂä†Âπ∂‰∏ã‰∏ÄÊ†π", total_count: "ÊÄªÊï∞", total_vol: "ÊùêÁßØ", modal_info_title: "È°πÁõÆ‰ø°ÊÅØ", modal_history: "ÂéÜÂè≤ËÆ∞ÂΩï", btn_close: "ÂÖ≥Èó≠", btn_copy: "Â§çÂà∂", back_edit: "ËøîÂõûÁºñËæëÊ®°Âºè", p_date: "Êó•Êúü", select_grade: "ÈÄâÊã©Á≠âÁ∫ß", quick_on: "‚ö° Âø´ÈÄüÊ®°Âºè: ÂºÄ", quick_off: "‚ö° Âø´ÈÄüÊ®°Âºè: ÂÖ≥" },
            en: { btn_new: "‚ü≥ Reset", btn_info: "üìã Info", btn_pdf: "PDF", btn_excel: "Export", container: "Container", note_global: "Global Note", seller: "Seller", measurer: "Measurer", location: "Location", my_company: "Company", code: "Code", grade: "Grade", len: "L(m)", dia: "D(cm)", vol: "Vol", note: "Note", idx: "#", inputting: "‚óè Inputting", add_next: "+ Add & Next", total_count: "Count", total_vol: "Volume", modal_info_title: "Project Info", modal_history: "History", btn_close: "Close", btn_copy: "Copy All", back_edit: "Back to Edit", p_date: "Date", select_grade: "Select Grade", quick_on: "‚ö° Quick Mode: ON", quick_off: "‚ö° Quick Mode: OFF" },
            sl: { btn_new: "‚ü≥ Nov", btn_info: "üìã Info", btn_pdf: "PDF", btn_excel: "Izvozi", container: "Kontejner", note_global: "Opomba", seller: "Prodajalec", measurer: "Merilec", location: "Lokacija", my_company: "Podjetje", code: "≈†t.", grade: "Razred", len: "D(m)", dia: "P(cm)", vol: "Vol", note: "Opomba", idx: "#", inputting: "‚óè Vnos", add_next: "+ Dodaj", total_count: "Koliƒçina", total_vol: "Volumen", modal_info_title: "Podatki", modal_history: "Zgodovina", btn_close: "Zapri", btn_copy: "Kopiraj", back_edit: "Nazaj", p_date: "Datum", select_grade: "Izberi Razred", quick_on: "‚ö° Hitro: ON", quick_off: "‚ö° Hitro: OFF" }
        };

        const STORAGE_KEY = 'oak_v25_data';
        const HIST_KEY = 'oak_v25_hist';
        const LANG_KEY = 'oak_v25_lang';
        const QUICK_KEY = 'oak_v25_quick';

        window.onload = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if(savedData) {
                const p = JSON.parse(savedData);
                logs = p.logs || [];
                globalInfo = p.global || globalInfo;
                ['container', 'note', 'seller', 'measurer', 'location', 'company'].forEach(k => {
                    const el = document.getElementById('g_'+k);
                    if(el) el.value = globalInfo[k] || '';
                });
            }
            const savedHist = localStorage.getItem(HIST_KEY);
            if(savedHist) histories = JSON.parse(savedHist);
            
            const savedLang = localStorage.getItem(LANG_KEY);
            if(savedLang) {
                currentLang = savedLang;
                document.getElementById('langSelect').value = currentLang;
            }
            const savedQuick = localStorage.getItem(QUICK_KEY);
            if(savedQuick === 'true') { isQuickMode = true; }
            
            applyLanguage();
            updateQuickBtnUI(); 

            if(logs.length === 0) addNewLog();
            renderAll();
        };

        function changeLanguage(lang) { currentLang = lang; localStorage.setItem(LANG_KEY, lang); applyLanguage(); renderAll(); updateQuickBtnUI(); }
        function applyLanguage() {
            const texts = I18N[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(texts[key]) el.innerText = texts[key]; });
            if(document.querySelector('.grade-label')) document.querySelector('.grade-label').innerText = texts.select_grade;
        }
        function updateGlobal() { ['container', 'note', 'seller', 'measurer', 'location', 'company'].forEach(k => { globalInfo[k] = document.getElementById('g_'+k).value; }); save(); }
        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ logs, global: globalInfo })); updateStats(); }
        function cleanInput(val) { if(!val) return ''; return val.replace(/,/g, '.').replace(/[^0-9.]/g, ''); }
        function autoFixInput(input) {
            let val = input.value;
            if(val.includes(',')) {
                input.value = val.replace(/,/g, '.');
                const id = input.getAttribute('data-id');
                const field = input.getAttribute('data-field');
                if(id && field) updateItem(parseInt(id), field, input.value);
            }
        }

        // --- Âø´ÈÄüÊ®°Âºè ---
        function toggleQuickMode() { isQuickMode = !isQuickMode; localStorage.setItem(QUICK_KEY, isQuickMode); updateQuickBtnUI(); }
        function updateQuickBtnUI() {
            const btn = document.getElementById('quickModeBtn');
            const t = I18N[currentLang];
            if(isQuickMode) { btn.classList.add('active'); btn.innerText = t.quick_on; } 
            else { btn.classList.remove('active'); btn.innerText = t.quick_off; }
        }

        function handleQuickLength(input, id) {
            if (!isQuickMode) return;
            let val = input.value;
            if (!val) return;
            if (/^\d+$/.test(val)) {
                let num = parseInt(val);
                let newVal = null;
                if (num >= 20 && num <= 99) newVal = (num / 10).toString();
                else if (num >= 101 && num <= 159) newVal = (num / 10).toString();
                if (newVal) {
                    input.value = newVal;
                    updateItem(id, 'length', newVal);
                    const diaInput = document.querySelector(`.log-card .field input[data-field="diameter"]`);
                    if(diaInput) diaInput.focus();
                }
            }
        }

        function getNextCode() {
            if(logs.length === 0) return '';
            const match = logs[0].code.match(/^(.*?)(\d+)$/);
            return match ? match[1] + (parseInt(match[2]) + 1).toString().padStart(match[2].length, '0') : logs[0].code; 
        }

        function addNewLog() {
            document.querySelectorAll('input').forEach(i => autoFixInput(i));
            // 3. ÈªòËÆ§Á≠âÁ∫ß‰∏∫Á©∫
            const newLog = { id: Date.now(), code: getNextCode(), grade: '', length: '', diameter: '', volume: 0, note: '' };
            logs.unshift(newLog);
            save();
            renderAll();
            activeFilter = null; 
            applyFilter();
            
            setTimeout(() => {
                const lenInput = document.querySelector(`.log-card .field input[data-field="length"]`);
                if(lenInput) {
                    lenInput.focus();
                    lenInput.click(); 
                }
            }, 10);
        }

        function renderAll() {
            const container = document.getElementById('logList');
            container.innerHTML = '';
            const t = I18N[currentLang];
            if(logs.length > 1) {
                const header = document.createElement('div');
                header.className = 'list-header';
                header.innerHTML = `<div>${t.idx}</div><div>${t.code}</div><div>${t.grade}</div><div>${t.len}</div><div>${t.dia}</div><div>${t.vol}</div><div>${t.note}</div><div></div>`;
                container.appendChild(header);
            }
            logs.forEach((log, index) => {
                const realIndex = logs.length - index;
                if(index === 0) container.insertBefore(createCard(log, realIndex), container.firstChild);
                else container.appendChild(createRow(log, realIndex));
            });
            updateStats();
            applyFilter();
        }

        function createCard(log, idx) {
            const t = I18N[currentLang];
            let btnsHtml = '';
            GRADES.forEach(g => {
                const isActive = log.grade === g ? 'active' : '';
                btnsHtml += `<button class="btn-grade ${isActive}" onmousedown="event.preventDefault()" onclick="setGrade(${log.id}, '${g}')">${g}</button>`;
            });

            const div = document.createElement('div');
            div.className = 'log-card';
            div.innerHTML = `
                <div class="card-title">${t.inputting} (NO. ${idx})</div>
                <div class="card-row-1">
                    <div class="field">
                        <label>${t.code}</label>
                        <input type="text" inputmode="numeric" id="curr_code_${log.id}" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)">
                    </div>
                    <div class="field"><label>${t.note}</label><input type="text" class="input-note" value="${log.note || ''}" oninput="updateItem(${log.id},'note',this.value)"></div>
                </div>
                <div class="card-row-2">
                    <div class="field"><label>${t.len}</label>
                        <input type="text" inputmode="decimal" class="in-l" value="${log.length}" 
                               data-id="${log.id}" data-field="length" 
                               oninput="updateItem(${log.id},'length',this.value); handleQuickLength(this, ${log.id})" 
                               onblur="autoFixInput(this)">
                    </div>
                    <div class="field"><label>${t.dia}</label>
                        <input type="text" inputmode="decimal" value="${log.diameter}" 
                               data-id="${log.id}" data-field="diameter" 
                               oninput="updateItem(${log.id},'diameter',this.value)" 
                               onblur="autoFixInput(this)">
                    </div>
                    <div class="live-vol-display" id="v-${log.id}">${log.volume.toFixed(3)} m¬≥</div>
                </div>
                <div class="grade-label">${t.select_grade}</div>
                <div class="grade-container">${btnsHtml}</div>
                <button class="btn-add-inline" onclick="addNewLog()">${t.add_next}</button>
            `;
            return div;
        }

        function createRow(log, idx) {
            // 3. ÂÖÅËÆ∏ÂàóË°®ÈÄâÊã©‰∏∫Á©∫ '-'
            let gradeOptions = `<option value="">-</option>`;
            gradeOptions += GRADES.map(g => `<option value="${g}" ${log.grade===g?'selected':''}>${g}</option>`).join('');
            
            const div = document.createElement('div');
            div.className = 'log-row';
            div.id = 'row-' + log.id;
            div.setAttribute('data-grade', log.grade || '?');
            
            const len_m = parseFloat(cleanInput(log.length.toString()));
            const d_cm = parseFloat(cleanInput(log.diameter.toString()));
            div.setAttribute('data-len', len_m || 0);
            div.setAttribute('data-dia', d_cm || 0);
            const warnClass = (len_m > 15) ? 'danger-text' : '';

            div.innerHTML = `
                <div class="row-index">${idx}</div>
                <input type="text" value="${log.code}" oninput="updateItem(${log.id},'code',this.value)">
                <select onchange="updateItem(${log.id},'grade',this.value)">${gradeOptions}</select>
                <input type="text" id="inp-len-${log.id}" class="${warnClass}" inputmode="decimal" value="${log.length}" oninput="updateItem(${log.id},'length',this.value)" onblur="autoFixInput(this)">
                <input type="text" inputmode="decimal" value="${log.diameter}" oninput="updateItem(${log.id},'diameter',this.value)" onblur="autoFixInput(this)">
                <div class="col-vol" id="v-row-${log.id}">${log.volume.toFixed(3)}</div>
                <input type="text" style="font-size:12px;color:#aaa;text-align:left;" value="${log.note||''}" oninput="updateItem(${log.id},'note',this.value)">
                <button class="btn-del-mini" onclick="delItem(${log.id})">√ó</button>
            `;
            return div;
        }

        function setGrade(id, grade) {
            updateItem(id, 'grade', grade);
            if (isQuickMode) { addNewLog(); } 
            else { renderAll(); } 
        }

        function updateItem(id, field, val) {
            const item = logs.find(l => l.id === id);
            item[field] = val;
            if(field === 'length' || field === 'diameter') {
                let l_str = item.length.toString().replace(/,/g, '.');
                let d_str = item.diameter.toString().replace(/,/g, '.');
                const l = parseFloat(l_str);
                const d = parseFloat(d_str);
                if (!isNaN(l) && !isNaN(d) && l > 0 && d > 0) {
                    const radius_m = d / 200;
                    item.volume = parseFloat((Math.PI * Math.pow(radius_m, 2) * l).toFixed(3));
                } else {
                    item.volume = 0;
                }
                const vDisplay = document.getElementById('v-'+id); if(vDisplay) vDisplay.innerText = item.volume.toFixed(3) + ' m¬≥';
                const vRowDisplay = document.getElementById('v-row-'+id); if(vRowDisplay) vRowDisplay.innerText = item.volume.toFixed(3);
                if(field === 'length') {
                    const rowLenInput = document.getElementById('inp-len-' + id);
                    if(rowLenInput) {
                        if(l > 15) rowLenInput.classList.add('danger-text');
                        else rowLenInput.classList.remove('danger-text');
                    }
                }
            }
            save();
            if(activeFilter) applyFilter();
        }

        function delItem(id) { if(confirm('Delete?')) { logs = logs.filter(l => l.id !== id); renderAll(); save(); } }
        
        function resetLogOnly() { 
            if(confirm('New Container? (Clear Logs & Container No.)')) { 
                logs = []; 
                globalInfo.container = '';
                document.getElementById('g_container').value = '';
                save(); 
                location.reload(); 
            } 
        }

        function updateStats() {
            const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
            const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
            document.getElementById('totalCount').innerText = validLogs.length;
            document.getElementById('totalVol').innerText = totalV.toFixed(3);
            
            const gStats = {}; 
            let l4 = 0, l25 = 0, d30 = 0;
            validLogs.forEach(l => {
                const g = l.grade || '?';
                gStats[g] = (gStats[g] || 0) + 1;
                const len_m = parseFloat(cleanInput(l.length.toString()));
                const d_cm = parseFloat(cleanInput(l.diameter.toString()));
                if(len_m < 4.0) l4++;
                if(len_m < 2.5) l25++;
                if(d_cm < 30) d30++;
            });

            let html = '';
            const mkTag = (key, label, count) => {
                if(count === 0) return '';
                const isActive = activeFilter === key ? 'active-filter' : '';
                return `<div class="stat-tag ${isActive}" onclick="toggleFilter('${key}')">${label}: <b>${count}</b></div>`;
            };
            for(let g in gStats) if(g!=='?' && g!=='') html += mkTag('g_'+g, g, gStats[g]);
            html += mkTag('l4', '< 4m', l4);
            html += mkTag('l25', '< 2.5m', l25);
            html += mkTag('d30', '< 30cm', d30);
            document.getElementById('statsDetail').innerHTML = html;

            // 2. ‰ºòÂåñÊâìÂç∞ÁªüËÆ°ÔºåÂ¢ûÂä†Èó¥Ë∑ù
            let summaryHtml = `<h3>${currentLang==='zh'?'ÁªüËÆ°Ê±áÊÄª':(currentLang==='en'?'Summary':'Povzetek')}</h3>
            <p>${I18N[currentLang].total_count}: ${validLogs.length} &nbsp; ${I18N[currentLang].total_vol}: ${totalV.toFixed(3)} m¬≥</p>
            <p>Grade: <br>`;
            for(let g in gStats) if(g!=='?' && g!=='') summaryHtml += `<span style="margin-right:20px; display:inline-block;">${g}: <b>${gStats[g]}</b></span>`;
            summaryHtml += `</p>`;
            document.getElementById('printSummary').innerHTML = summaryHtml;
        }

        function toggleFilter(key) {
            if(activeFilter === key) activeFilter = null;
            else activeFilter = key;
            updateStats();
            applyFilter();
        }

        function applyFilter() {
            const rows = document.querySelectorAll('.log-row');
            if(!activeFilter) {
                rows.forEach(r => { r.classList.remove('dimmed', 'highlighted'); });
                return;
            }
            rows.forEach(r => {
                let match = false;
                const g = r.getAttribute('data-grade');
                const l = parseFloat(r.getAttribute('data-len'));
                const d = parseFloat(r.getAttribute('data-dia'));
                if(activeFilter.startsWith('g_') && activeFilter === 'g_' + g) match = true;
                else if(activeFilter === 'l4' && l < 4.0) match = true;
                else if(activeFilter === 'l25' && l < 2.5) match = true;
                else if(activeFilter === 'd30' && d < 30) match = true;
                if(match) { r.classList.add('highlighted'); r.classList.remove('dimmed'); } 
                else { r.classList.add('dimmed'); r.classList.remove('highlighted'); }
            });
        }

        function openInfoModal() { document.getElementById('infoModal').style.display = 'flex'; }
        function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; updateGlobal(); }

        function togglePrintMode() {
            const body = document.body;
            if (body.classList.contains('print-mode')) {
                body.classList.remove('print-mode');
            } else {
                const d = new Date();
                const t = I18N[currentLang];
                const dateStr = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
                
                // 1. PDF Êô∫ËÉΩÈöêËóèÁ©∫Ë°å
                document.getElementById('p_company').innerText = globalInfo.company;
                document.getElementById('print_row_company').style.display = globalInfo.company ? 'table-row' : 'none';

                document.getElementById('p_date').innerText = dateStr;
                document.getElementById('p_container').innerText = globalInfo.container;
                
                document.getElementById('p_seller').innerText = globalInfo.seller;
                document.getElementById('p_location').innerText = globalInfo.location;
                document.getElementById('print_row_seller').style.display = (!globalInfo.seller && !globalInfo.location) ? 'none' : 'table-row';

                document.getElementById('p_measurer').innerText = globalInfo.measurer;
                // 1. ÊµãÈáè‰∫∫Ë°åÈöêËóè
                document.getElementById('print_row_measurer').style.display = globalInfo.measurer ? 'table-row' : 'none';

                document.getElementById('p_note').innerText = globalInfo.note;
                document.getElementById('print_row_note').style.display = (!globalInfo.note) ? 'none' : 'table-row';

                body.classList.add('print-mode');
                setTimeout(() => { try { window.print(); } catch(e){} }, 300);
            }
        }

        async function exportData() {
            const d = new Date(); 
            const timeStr = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}_${d.getHours()}-${d.getMinutes()}-${d.getSeconds()}`;
            const ds = d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate();
            const t = I18N[currentLang];
            
            let header = `\ufeff${t.p_date},${ds}\n`;
            if(globalInfo.company) header += `${t.my_company},${globalInfo.company}\n`;
            if(globalInfo.container) header += `${t.container},${globalInfo.container}\n`;
            if(globalInfo.note) header += `${t.note_global},${globalInfo.note}\n`;
            if(globalInfo.seller) header += `${t.seller},${globalInfo.seller}\n`;
            if(globalInfo.measurer) header += `${t.measurer},${globalInfo.measurer}\n`;
            if(globalInfo.location) header += `${t.location},${globalInfo.location}\n`;
            
            let csv = header + `\n${t.idx},${t.code},${t.grade},${t.len},${t.dia},${t.vol},${t.note}\n`;
            
            const validLogs = logs.filter(l => parseFloat(l.volume) > 0);
            [...validLogs].reverse().forEach((l, idx) => { 
                let len = l.length.replace(/,/g, '.');
                let dia = l.diameter.replace(/,/g, '.');
                csv += `${idx+1},${l.code},${l.grade},${len},${dia},${l.volume.toFixed(3)},${l.note||''}\n`; 
            });
            
            const totalV = validLogs.reduce((s, l) => s + l.volume, 0);
            let l4 = 0, l25 = 0, d30 = 0;
            validLogs.forEach(l => {
                const len_m = parseFloat(l.length.replace(/,/g, '.'));
                const dia_cm = parseFloat(l.diameter.replace(/,/g, '.'));
                if(len_m < 4.0) l4++;
                if(len_m < 2.5) l25++;
                if(dia_cm < 30) d30++;
            });

            csv += `\n\n=== ${currentLang==='zh'?'ÁªüËÆ°':'Summary'} ===\n`;
            csv += `${t.total_count},${validLogs.length}\n${t.total_vol},${totalV.toFixed(3)}\n`;
            csv += `\n< 4m,${l4}\n< 2.5m,${l25}\n< 30cm,${d30}\n\n`;
            csv += `=== ${t.grade} ===\n`;
            const gStats = {}; validLogs.forEach(l => { gStats[l.grade] = (gStats[l.grade] || 0) + 1; });
            for(let g in gStats) if(g!=='?' && g!=='') csv += `${g},${gStats[g]}\n`;

            const fileName = `Oak_${timeStr}.csv`;

            if (navigator.share) {
                try { await navigator.share({ files: [new File([csv], fileName, {type: 'text/csv'})], title: 'Export' }); return; } catch (e) {}
            }
            document.getElementById('exportText').value = csv;
            document.getElementById('exportModal').style.display = 'flex';
        }
        function copyExportText() { document.getElementById('exportText').select(); document.execCommand('copy'); alert('Copied'); document.getElementById('exportModal').style.display='none'; }
        
        function saveToHistory(t){const v=document.getElementById('g_'+t).value.trim();if(v&&!histories[t].includes(v)){histories[t].push(v);localStorage.setItem(HIST_KEY,JSON.stringify(histories));alert('Saved');}}
        function showHistory(t){
            const l=document.getElementById('historyList');l.innerHTML='';
            const items = histories[t] || [];
            if(items.length===0) l.innerHTML='<div style="padding:10px;color:#666;">No Record</div>';
            items.forEach((i,x)=>{
                const d=document.createElement('div');
                d.style.cssText='padding:12px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;';
                d.innerHTML=`<div onclick="selectHistory('${t}','${i}')" style="flex:1;color:#fff;">${i}</div><div onclick="delHistory('${t}',${x})" style="color:red;padding:5px 10px;font-size:18px;">√ó</div>`;
                l.appendChild(d);
            });
            document.getElementById('historyPop').style.display='flex';
        }
        function selectHistory(t,v){document.getElementById('g_'+t).value=v;globalInfo[t]=v;document.getElementById('historyPop').style.display='none';save();}
        function delHistory(t,i){histories[t].splice(i,1);localStorage.setItem(HIST_KEY,JSON.stringify(histories));showHistory(t);}
    </script>
</body>
</html>
